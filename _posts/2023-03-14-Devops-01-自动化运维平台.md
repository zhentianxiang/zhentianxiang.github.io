---
layout: post
title: 2023-03-14-Devops-01-自动化运维平台
date: 2023-03-14
tags: Devops
---

# Devops-自动化运维平台

## 一、部署 Gitlab

### 1. 准备 redis

```sh
[root@k8s-master01 gitlab]# cat > namespace.yaml <<EOF
apiVersion: v1
kind: Namespace
metadata:
  name: dev-ops
EOF
[root@k8s-master01 gitlab]# cat > gitlab-redis-pvc.yaml <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-redis-pvc
  namespace: dev-ops
spec:
  storageClassName: "nfs-provisioner-storage"
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
EOF
[root@master01 redis]# cat > gitlab-redis.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: dev-ops
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      initContainers:
      - name: system-init
        image: busybox:1.32
        imagePullPolicy: IfNotPresent
        command:
        - "/bin/sh"
        - "-c"
        - |
          echo "调整内存大页"
          echo 2048 > /proc/sys/net/core/somaxconn && echo never > /sys/kernel/mm/transparent_hugepage/enabled
        securityContext:
          privileged: true
          runAsUser: 0
        volumeMounts:
        - name: sys
          mountPath: /sys
      containers:
      - name: redis
        image: redis:6.2
        imagePullPolicy: IfNotPresent
        ports:
        - name: redis
          containerPort: 6379
          protocol: TCP
        resources:
          limits:
            cpu: 1000m
            memory: 2Gi
          requests:
            cpu: 500m
            memory: 500Mi
        # 存活探针
        livenessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 30
          timeoutSeconds: 5
        # 就绪性探针
        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 30
          timeoutSeconds: 1
        volumeMounts:
          - name: host-time
            mountPath: /etc/localtime
            readOnly: true
          - name: redis-data
            mountPath: /data
      volumes:
      - name: host-time
        hostPath:
          path: /etc/localtime
      - name: sys
        hostPath:
          path: /sys
      - name: redis-data
        persistentVolumeClaim:
          claimName: gitlab-redis-pvc
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: dev-ops
  labels:
    app: redis
spec:
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
  selector:
    app: redis
EOF
```

### 2. 准备 postgresql

```sh
[root@master01 postgres]# ls
gitlab-postgresql-pvc.yaml  gitlab-postgresql.yaml
[root@master01 postgres]# cat > gitlab-postgresql-pvc.yaml <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-postgresql-pvc
  namespace: dev-ops
spec:
  storageClassName: "nfs-provisioner-storage"
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 30Gi
[root@master01 postgres]# cat > gitlab-postgresql.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgresql
  namespace: dev-ops
  labels:
    app: postgresql
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      containers:
      - name: postgresql
        image: sameersbn/postgresql:14-20230628
        imagePullPolicy: IfNotPresent
        ports:
        - name: postgres
          containerPort: 5432
        env:
        - name: DB_USER
          value: gitlab
        - name: DB_PASS
          value: passw0rd
        - name: DB_NAME
          value: gitlab_production
        - name: DB_EXTENSION
          value: 'pg_trgm,btree_gist'
        resources: 
          requests:
            cpu: 2
            memory: 2Gi
          limits:
            cpu: 2
            memory: 2Gi
        livenessProbe:
          exec:
            command:
              - "/bin/bash"
              - "-c"
              - |
                if psql -U gitlab -d gitlab_production -c 'SELECT 1;' > /dev/null 2>&1; then
                  exit 0
                else
                  exit 1
                fi
          initialDelaySeconds: 30
          timeoutSeconds: 5
          periodSeconds: 10
          successThreshold: 1
          failureThreshold: 3
        
        readinessProbe:
          exec:
            command:
              - "/bin/bash"
              - "-c"
              - |
                if psql -U gitlab -d gitlab_production -c 'SELECT 1;' > /dev/null 2>&1; then
                  exit 0
                else
                  exit 1
                fi
          initialDelaySeconds: 5
          timeoutSeconds: 1
          periodSeconds: 10
          successThreshold: 1
          failureThreshold: 3
        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql
        - name: host-time
          mountPath: /etc/localtime
      volumes:
      - name: host-time
        hostPath:
          path: /etc/localtime
      - name: data
        persistentVolumeClaim:
          claimName: gitlab-postgresql-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: postgresql
  namespace: dev-ops
  labels:
    app: postgresql
spec:
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
  selector:
    app: postgresql
EOF
```

| **参数名称** | **默认值** | **描述**                 |
| ------------ | ---------- | ------------------------ |
| DB_USER      | -          | 创建一个数据库用户       |
| DB_PASS      | -          | 指定创建的用户的密码     |
| DB_NAME      | -          | 创建一个数据库并指定库名 |
| DB_EXTENSION | -          | 指定安装的扩展包         |


### 3. 准备 gitlab

```sh
[root@master01 gitlab]# ls
gitlab-pvc.yaml gitlab.yaml
[root@master01 gitlab]# cat > gitlab-pvc.yaml <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-pvc
  namespace: dev-ops
spec:
  storageClassName: "nfs-provisioner-storage"
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
EOF
[root@master01 gitlab]# cat > gitlab.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab
  namespace: dev-ops
  labels:
    app: gitlab
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gitlab
  template:
    metadata:
      labels:
        app: gitlab
    spec:
      containers:
      - name: gitlab
        image: sameersbn/gitlab:16.10.0
        imagePullPolicy: IfNotPresent
        env:
        - name: TZ
          value: "Asia/Shanghai"
        - name: GITLAB_TIMEZONE
          value: "Beijing"
        - name: GITLAB_SECRETS_DB_KEY_BASE
          value: "long-and-random-alpha-numeric-string"
        - name: GITLAB_SECRETS_SECRET_KEY_BASE
          value: "long-and-random-alpha-numeric-string"
        - name: GITLAB_SECRETS_OTP_KEY_BASE
          value: "long-and-random-alpha-numeric-string"
        - name: GITLAB_ROOT_PASSWORD  # 首次运行时 root 用户的密码。默认为5iveL!fe。GitLab 要求其长度至少为8 个字符
          value: "5iveL!fe"
        - name: GITLAB_ROOT_EMAIL
          value: "2099637909@qq.com"
        - name: SMTP_ENABLED
          value: "true"
        - name: SMTP_HOST
          value: "smtp.qq.com"
        - name: SMTP_PORT
          value: "465"
        - name: SMTP_USER
          value: "2099637909@qq.com"
        - name: SMTP_PASS
          value: "xxxxxxx"
        - name: SMTP_TLS
          value: "true"
        - name: GITLAB_HOST
          value: "k8s-gitlab.localhost.com"
        # 开启 https,这个只是你在用 gitlab 的时候，比如打开页面，pull push 走的是 https 了，并不是后端服务真的监听了一个443端口
        #- name: GITLAB_HTTPS
        #  value: "true"
        # 如果证书是自己签的，那么需要把 ca 证书添加到 gitlab 中
        #- name: SSL_SELF_SIGNED
        #  value: "false"
        # 如果开启 https 的话，把短裤换成 443
        - name: GITLAB_PORT
          value: "80"
        # clone 的时候 ssh 端口 30022
        - name: GITLAB_SSH_PORT
          value: "30022"
        - name: GITLAB_NOTIFY_ON_BROKEN_BUILDS
          value: "true"
        - name: GITLAB_NOTIFY_PUSHER
          value: "false"
        - name: GITLAB_BACKUP_SCHEDULE
          value: "daily"
        - name: GITLAB_BACKUP_TIME
          value: "01:00"
        - name: DB_TYPE
          value: "postgres"
        - name: DB_HOST
          value: "postgresql"
        - name: DB_PORT
          value: "5432"
        - name: DB_USER
          value: "gitlab"
        - name: DB_PASS
          value: "passw0rd"
        - name: DB_NAME
          value: "gitlab_production"
        - name: REDIS_HOST
          value: "redis"
        - name: REDIS_PORT
          value: "6379"
        ports:
        - name: http
          containerPort: 80
        - name: https
          containerPort: 443
        - name: ssh
          containerPort: 22
        resources:
          limits:
            cpu: 8
            memory: 16Gi
          requests:
            cpu: 4
            memory: 8Gi
        livenessProbe:
          httpGet:
            path: /users/sign_in
            port: 80 # 不论是不是 https ，这个端口永远都是80
            scheme: HTTP
          initialDelaySeconds: 300
          timeoutSeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /users/sign_in  # GitLab登录页面是常用的健康检查端点
            port: 80
            scheme: HTTP
          initialDelaySeconds: 60  # 可以比liveness probe短一些
          timeoutSeconds: 5
          periodSeconds: 10
        volumeMounts:
        - mountPath: /etc/localtime
          readOnly: true
          name: host-time
        - mountPath: /home/git/data
          name: data
      volumes:
      - name: host-time
        hostPath:
          path: /etc/localtime
      - name: data
        persistentVolumeClaim:
          claimName: gitlab-pvc
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gitlab
  namespace: dev-ops
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
  labels:
    name: gitlab-ingress
spec:
  ingressClassName: nginx
  rules:
  - host: k8s-gitlab.localhost.com
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: gitlab
            port:
              number: 80
---
apiVersion: v1
kind: Service
metadata:
  name: gitlab
  namespace: dev-ops
  labels:
    app: gitlab
spec:
  type: NodePort
  ports:
    - name: http
      port: 80
      targetPort: 80
      nodePort: 30080
    - name: ssh
      port: 22
      targetPort: 22
      nodePort: 30022
  selector:
    app: gitlab
EOF
```

**注意：第一次启动 gitlab 失败重启一次，因为他第一次启动会初始化数据库创建一些参数配置**

**参数说明：**

| **参数名称**                   | **默认值**                                    | **描述**                                                     |
| ------------------------------ | --------------------------------------------- | ------------------------------------------------------------ |
| GITLAB_TIMEZONE                | UTC                                           | 指定时区                                                     |
| GITLAB_SECRETS_DB_KEY_BASE     | -                                             | 用于加密数据库中的CI机密变量以及导入凭据。如果丢失或旋转了此机密，则将无法使用现有的CI机密 |
| GITLAB_SECRETS_SECRET_KEY_BASE | -                                             | 用于密码重置链接和其他“标准”身份验证功能。如果丢失或旋转了此机密，电子邮件中的密码重置令牌将重置 |
| GITLAB_SECRETS_OTP_KEY_BASE    | -                                             | 用于加密数据库中的2FA机密。如果您丢失或旋转了此机密，则您的所有用户都将无法使用 2FA 登录 |
| GITLAB_ROOT_PASSWORD           | 5iveL!fe                                      | 指定 root 用户在首次运行时的密码（注意：GitLab 要求长度至少为8个字符） |
| GITLAB_ROOT_EMAIL              | [admin@example.com](mailto:admin@example.com) | 指定 root 用户在首次运行时的电子邮件                         |
| GITLAB_HOST                    | [localhost](http://localhost/)                | 指定 GitLab 服务器的主机名，默认为[localhost](http://localhost/)，修改此参数可用配置Gitlab库中的克隆地址 |
| GITLAB_PORT                    | 80                                            | 指定 GitLab 服务器的端口号，修改此参数可用配置 Gitlab 库中的克隆地址的端口号 |
| GITLAB_SSH_PORT                | $GITLAB_SSH_LISTEN_PORT                       | 指定 ssh 端口号                                              |
| GITLAB_NOTIFY_ON_BROKEN_BUILDS | true                                          | 启用或禁用通知的电子邮件                                     |
| GITLAB_NOTIFY_PUSHER           | true                                          | 将推送程序添加到构建通知电子邮件的收件人列表中               |
| GITLAB_NOTIFY_PUSHER           | false                                         | 将推送程序添加到构建通知电子邮件的收件人列表中               |
| **GITLAB_BACKUP_SCHEDULE**     | **daily weekly monthly disable**              | **备份方式**                                                 |
| **GITLAB_BACKUP_TIME**         | **01:00**                                     | **备份时间**                                                 |
| DB_TYPE                        | postgres                                      | 指定数据库类型                                               |
| DB_HOST                        | [localhost](http://localhost/)                | 指定数据库主机地址（k8s service地址）                        |
| DB_PORT                        | 5432                                          | 指定数据库服务器端口                                         |
| DB_USER                        | root                                          | 指定数据库用户名                                             |
| DB_PASS                        | -                                             | 指定数据库密码                                               |
| DB_NAME                        | gitlabhq_production                           | 指定数据库名                                                 |
| REDIS_HOST                     | [localhost](http://localhost/)                | 指定 Redis 的主机地址                                        |
| REDIS_PORT                     | 6379                                          | 指定 Redis 端口                                              |



配置CPU自动扩缩容
```sh
[root@VM-16-9-centos gitlab]# kubectl autoscale deployment -n dev-ops gitlab --cpu-percent=50 --min=1 --max=5
```
```sh
[root@master01 gitlab]# kubectl get pods,svc -n gitlab
NAME                              READY   STATUS    RESTARTS   AGE
pod/gitlab-6dd5dc965b-7vg8r       1/1     Running   1          42m
pod/postgresql-5d5d6bc448-x9pbt   1/1     Running   2          44m
pod/redis-dc77f47d8-lsk28         1/1     Running   0          57m

NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                     AGE
service/gitlab       NodePort    10.102.142.173   <none>        80:30080/TCP,22:30022/TCP   42m
service/postgresql   ClusterIP   10.107.39.86     <none>        5432/TCP                    46m
service/redis        ClusterIP   10.101.243.65    <none>        6379/TCP                    57m
```

## 二、部署 Jenkins-master

### 1. 制作镜像

如果后期一直使用 slave 端用作为任务执行，该镜像完全可以不用制作，因为不用跑任何流水线任务方可不必

```sh
[root@master01 dockerfile]# cp /root/.ssh/id_rsa .
[root@master01 dockerfile]# cp /root/.docker/config.json .
[root@master01 dockerfile]# curl -fsSL get.docker.com -o get-docker.sh && chmod o+x get-docker.sh
[root@master01 dockerfile]# vim Dockerfile
FROM jenkins/jenkins:2.394
USER root
RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\
    echo "Asia/Shanghai" >/etc/timezone &&\
    echo "jenkins ALL=NOPASSWD: ALL" >> /etc/sudoers &&\
    sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list &&\
    apt update &&\
    apt install -y vim telnet

COPY id_rsa /root/.ssh/id_rsa
COPY config.json /root/.docker/config.json
COPY get-docker.sh /get-docker.sh
RUN echo "    StrictHostKeyChecking no" >> /etc/ssh/ssh_config && /get-docker.sh
[root@master01 dockerfile]# docker build . -t 11.0.1.5/dev-ops/jenkins-tls:v1
[root@master01 dockerfile]# docker push 11.0.1.5/dev-ops/jenkins-tls:v1
```

### 2. 准备 yaml 文件

```sh
[root@master01 jenkins]# cat > jenkins_rbac.yaml <<EOF
cat namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: dev-ops
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jenkins-sa
  namespace: dev-ops
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: jenkins-crd
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: ServiceAccount
  name: jenkins-sa
  namespace: dev-ops
EOF

[root@master01 jenkins]# cat > jenkins_pvc.yaml <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jenkins-pvc
  namespace: dev-ops
  annotations:
    volume.beta.kubernetes.io/storage-class: "nfs-provisioner-storage"
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
EOF

[root@master01 jenkins]# cat > jenkins_deploy.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jenkins
  namespace: dev-ops
  labels:
    app: jenkins
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jenkins
  template:
    metadata:
      labels:
        app: jenkins
    spec:
      hostAliases:
      terminationGracePeriodSeconds: 10
      serviceAccount: jenkins-sa
      containers:
      - name: jenkins
        image: 11.0.1.5/dev-ops/jenkins-tls:v1
        imagePullPolicy: IfNotPresent
        env:
        - name: JAVA_OPTS
          value: -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85 -Duser.timezone=Asia/Shanghai
        ports:
        - containerPort: 8080
          name: web
          protocol: TCP
        - containerPort: 50000
          name: agent
          protocol: TCP
        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /login
            port: 8080
          initialDelaySeconds: 60
          timeoutSeconds: 5
          failureThreshold: 12
        readinessProbe:
          httpGet:
            path: /login
            port: 8080
          initialDelaySeconds: 60
          timeoutSeconds: 5
          failureThreshold: 12
        volumeMounts:
        - name: host-time
          mountPath: /etc/localtime
          readOnly: true  
        - name: jenkinshome
          mountPath: /var/jenkins_home
        - name: docker-sock
          mountPath: /run/docker.sock
        - name: docker-command
          mountPath: /usr/bin/docker
      securityContext:
        runAsUser: 0
      volumes:
      - name: host-time
        hostPath:
          path: /etc/localtime
      - name: jenkinshome
        persistentVolumeClaim:
          claimName: jenkins-pvc
      - name: docker-sock
        hostPath:
          path: /run/docker.sock
          type: ''
      - name: docker-command
        hostPath:
          path: /usr/bin/docker
          type: ''
---
apiVersion: v1
kind: Service
metadata:
  name: jenkins
  namespace: dev-ops
  labels:
    app: jenkins
spec:
  selector:
    app: jenkins
  type: NodePort
  ports:
  - name: web
    port: 8080
    targetPort: 8080
    nodePort: 30001
  - name: agent
    port: 50000
    targetPort: 50000
EOF

[root@master01 jenkins]# cat > jenkins_ingress.yaml <<EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: jenkins-ingress
  namespace: dev-ops
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
  labels:
    name: jenkins-ingress
spec:
  rules:
  - host: jenkins.demo.com
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: jenkins
            port:
              number: 8080
EOF
```

**coredns 配置 host 解析**

- HOSTS 解析解决全部POD快速dns解析保证容器内服务正常调用

```sh
[root@master01 jenkins]# kubectl edit cm -n kube-system coredns

# Please edit the object below. Lines beginning with a '#' will be ignored,
# and an empty file will abort the edit. If an error occurs while saving this file will be
# reopened with the relevant failures.
#
apiVersion: v1
data:
  Corefile: |
    .:53 {
        errors
        health {
           lameduck 5s
        }
        hosts {
          11.0.1.110 gitlab.demo.com jenkins.demo.com sonarqube.demo.com         # 配置解析
          fallthrough
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf {
           max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
    }
kind: ConfigMap
metadata:
  creationTimestamp: "2023-03-08T14:21:30Z"
  name: coredns
  namespace: kube-system
  resourceVersion: "34978"
  selfLink: /api/v1/namespaces/kube-system/configmaps/coredns
  uid: 660ff8dd-9ffd-43b3-aeec-41e1c96f8ce5
```

**coredns 配置外部 DNS 解析

- DNS转发解决全部容器对指定域名转发到指定dns服务器

```sh
  Corefile: |
    .:53 {
        errors
        health {
           lameduck 5s
        }
        hosts {
          11.0.1.110 gitlab.demo.com jenkins.demo.com sonarqube.demo.com         # 配置解析
          fallthrough
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf {
           max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
    }

      # DNS 转发解析
      demo.com:53 {
          errors
          cache 30
          forward . 192.168.1.89  # DNS 服务器
          reload
      }
```

### 3. 启动服务

```sh
[root@master01 jenkins]# kubectl apply -f namespace.yaml
[root@master01 jenkins]# kubectl apply -f jenkins_rbac.yaml
[root@master01 jenkins]# kubectl apply -f jenkins_pvc.yaml
[root@master01 jenkins]# kubectl apply -f jenkins_deploy.yaml
[root@master01 jenkins]# kubectl apply -f jenkins_ingress.yaml
[root@master01 jenkins]# kubectl logs -n dev-ops jenkins-6ff748dd95-5l6z4 -f
VM settings:
    Max. Heap Size (Estimated): 247.50M
    Using VM: OpenJDK 64-Bit Server VM

Running from: /usr/share/jenkins/jenkins.war
................
................
................
Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:

d2727d2564bf407ea9bf2412ac0a1816     # 登陆密码
```

配置 hosts 解析

```sh
[root@master01 jenkins]# kubectl get pods -n ingress-nginx -o wide
NAME                                       READY   STATUS      RESTARTS   AGE     IP               NODE     NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-79vj8       0/1     Completed   0          5h53m   10.244.196.129   node01   <none>           <none>
ingress-nginx-admission-patch-5c2x8        0/1     Completed   1          5h53m   10.244.140.67    node02   <none>           <none>
ingress-nginx-controller-b7d7b74b8-dvt7q   1/1     Running     0          5h53m   11.0.1.32        node01   <none>           <none>

# 因为我的 ingress pod 在 node01 节点，所以解析也需要写对应的
[root@master01 jenkins]# vim /etc/hosts

127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
11.0.1.110 apiserver.cluster.local
11.0.1.29 master01
11.0.1.5 master02
11.0.1.31 master03
11.0.1.32 node01
11.0.1.33 node02

# ingress-nginx
11.0.1.32 jenkins.demo.com
```

### 4. 配置 Jenkins

![](/images/posts/Devops/Devops-01-自动化运维平台/1.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/2.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/3.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/4.png)

#### 4.1 修改 Jenkins 插件源

```sh
[root@master01 ~]# kubectl get pvc -n dev-ops
NAME          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS              AGE
jenkins-pvc   Bound    pvc-eba92b70-9f14-4faa-84f6-651cab4fe75c   10Gi       RWX            nfs-provisioner-storage   3m6s

[root@master01 ~]# cd /data/k8s_nfs/dev-ops-jenkins-pvc-pvc-eba92b70-9f14-4faa-84f6-651cab4fe75c/updates
[root@master01 updates]# sed -i 's#https://updates.jenkins.io/download#http://mirrors.aliyun.com/jenkins#g' default.json
[root@master01 updates]# sed -i 's/www.google.com/www.baidu.com/g' default.json
```

![](/images/posts/Devops/Devops-01-自动化运维平台/5.png)

```sh
http://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json
```

#### 4.2 安装中文插件

![](/images/posts/Devops/Devops-01-自动化运维平台/6.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/7.png)

### 5. 配置 sonarqube

https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/

```sh
[root@k8s-master01 ~]# cd /data/k8s_nfs/jenkins-jenkins-pvc-pvc-01eb06ee-11d8-4b91-9e11-bd2b1c342154/
[root@k8s-master01 jenkins-jenkins-pvc-pvc-01eb06ee-11d8-4b91-9e11-bd2b1c342154]# wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip
[root@k8s-master01 jenkins-jenkins-pvc-pvc-01eb06ee-11d8-4b91-9e11-bd2b1c342154]# unzip sonar-scanner-cli-4.7.0.2747-linux.zip
[root@k8s-master01 jenkins-jenkins-pvc-pvc-01eb06ee-11d8-4b91-9e11-bd2b1c342154]# mv sonar-scanner-4.7.0.2747-linux/ sonar-scanner
[root@k8s-master01 jenkins-jenkins-pvc-pvc-01eb06ee-11d8-4b91-9e11-bd2b1c342154]# vim sonar-scanner/conf/sonar-scanner.properties
#Configure here general information about the environment, such as SonarQube server connection details for example
#No information about specific project should appear here

#----- Default SonarQube server
sonar.host.url=http://sonarqube.demo.com/

#----- Default source code encoding
sonar.sourceEncoding=UTF-8

```

## 二、部署 jenkins-slave

### 1. 制作镜像

[jdk-8u231-linux-x64](https://www.oracle.com/java/technologies/javase/javase8u211-later-archive-downloads.html)

```sh
[root@master01 jenkins-slave]# cp -ra ~/.kube/ kube
[root@master01 jenkins-slave]# cp -ra ~/.docker docker
[root@master01 jenkins-slave]# cp /usr/bin/kubectl .
[root@master01 jenkins-slave]# wget https://raw.githubusercontent.com/jenkinsci/docker-inbound-agent/master/jenkins-agent
[root@master01 jenkins-slave]# chmod 755 jenkins-agent
[root@master01 jenkins-slave]# mv jenkins-agent jenkins-slave
[root@master01 jenkins-slave]# curl -fsSL get.daocloud.io/docker -o get-docker.sh && chmod o+x get-docker.sh
[root@master01 jenkins-slave]# wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip
[root@master01 jenkins-slave]# unzip sonar-scanner-cli-4.7.0.2747-linux.zip
[root@master01 jenkins-slave]# mv sonar-scanner-4.7.0.2747-linux/ sonar-scanner
[root@master01 jenkins-slave]# vim sonar-scanner/conf/sonar-scanner.properties
# 提前准备好 sonarqube 的登录信息
sonar.host.url=http://sonarqube.demo.com/
sonar.login = admin
sonar.password = tx010910.
# 关闭sonar内置java
[root@master01 jenkins-slave]# sed -i 's/use_embedded_jre=true/use_embedded_jre=false/g' sonar-scanner/bin/sonar-scanner
[root@master01 jenkins-slave]# rm -rf sonar-scanner/jre/
[root@master01 jenkins-slave]# wget https://archive.apache.org/dist/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz
[root@master01 jenkins-slave]# tar xvf apache-maven-3.6.3-bin.tar.gz
# 146 行下面插入以下内容
[root@master01 jenkins-slave]# vim apache-maven-3.6.3/conf/settings.xml

    <mirror>
       <id>aliyunmaven</id>
       <mirrorOf>*</mirrorOf>
       <name>阿里云公共仓库</name>
       <url>https://maven.aliyun.com/repository/public</url>
    </mirror>


# 如需配置 jdk 环境如下，252行下面添加，镜像中包含了 jdk 环境所以不需要做这个了
[root@master01 jenkins-slave]# vim apache-maven-3.6.3/conf/settings.xml
   <profile>
     <id>jdk8</id>
     <activation>
         <activeByDefault>true</activeByDefault>
         <jdk>1.8</jdk>
     </activation>
     <properties>
         <maven.compiler.source>1.8</maven.compiler.source>
         <maven.compiler.target>1.8</maven.compiler.target>
         <maven.compiler.compilerVersion>1.8</maven.compiler.compilerVersion>
     </properties>
 </profile>

# 配置 sonarqube，252行下面添加，maven 构建时扫描代码使用此项，配合 pom.xml插件
[root@master01 jenkins-slave]# vim apache-maven-3.6.3/conf/settings.xml
   <profile>
       <id>sonar</id>
       <activation>
           <activeByDefault>true</activeByDefault>
       </activation>
       <properties>
           <sonar.login>admin</sonar.login>
           <sonar.password>tx010910.</sonar.password>
           <sonar.host.url>http://sonarqube.demo.com/</sonar.host.url>
         </properties>
     </profile>

[root@master01 jenkins-slave]# cp apache-maven-3.6.3/conf/settings.xml .
[root@master01 jenkins-slave]# wget https://www.python.org/ftp/python/3.6.0/Python-3.6.0.tgz
[root@master01 jenkins-slave]# vim Dockerfile
FROM centos:centos7
RUN  mkdir /etc/yum.repos.d/bak && mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak && \
     curl -o /etc/yum.repos.d/CentOS7-Base-163.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo && \
     yum makecache && \
     yum -y install gcc make wget curl git telnet ibtool-ltdl-devel openssl-devel bzip2-devel expat-devel gdbm-devel readline-devel sqlite-devel

COPY docker ~/.docker
COPY kube ~/.kube/
COPY jenkins-slave /usr/bin/jenkins-slave
COPY sonar-scanner /usr/local/sonar-scanner
RUN ln -s /usr/local/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner
ADD  apache-maven-3.6.3-bin.tar.gz /usr/local/
COPY settings.xml /usr/local/apache-maven-3.6.3/conf/settings.xml
ADD  jdk-8u231-linux-x64.tar.gz /usr/local/
ENV  PATH=$PATH:/usr/local/apache-maven-3.6.3/bin
ENV  JAVA_HOME=/usr/local/jdk1.8.0_231
ENV  PATH=$JAVA_HOME/bin:$JAVA_HOME/bin:$PATH
ENV  CLASSPATH=$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/lib/tools.jar
COPY kubectl /usr/bin/kubectl
COPY get-docker.sh /get-docker.sh
ADD  Python-3.6.0.tgz /usr/local/
RUN  /usr/local/Python-3.6.0/configure --prefix=/usr/local && \
     make && make install && \
     ln -s /usr/local/bin/python3.6.0 /usr/bin/python3 && \
     sed -i 's/python/python2/g' /usr/bin/yum && \
     sed -i 's/python/python2/g' /usr/libexec/urlgrabber-ext-down && \
     /get-docker.sh
ENTRYPOINT ["jenkins-slave"]

[root@master01 jenkins-slave]# docker build . -t 11.0.1.5/dev-ops/jenkins-slave:v1
[root@master01 jenkins-slave]# docker push docker build . -t 11.0.1.5/dev-ops/jenkins-slave:v1
```

### 2. 配置 kubernetes 插件

![](/images/posts/Devops/Devops-01-自动化运维平台/8.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/9.png)

```sh
 注意：这个是最重要的一个配置，决定整个安装的成败，"kubernetes地址" 用"https://kubernetes.default"或者"https://k8s集群主节点的ip+端口"，然后点击"连接测试"，连接成功会出现k8s版本号。
 　　　为什么连k8s不需要凭证：jenkins是在k8s内部搭建的，所以不需要k8s凭证，如果是在外部搭建的就需要添加k8s凭证
 　　　jenkins地址： kubectl get svc 　　#查看jenkins的端口
 　　　jenkins通道：这个参数是Jenkins Master和Jenkins Slave之间通信必须配置的，kubectl get svc 　　#查看ip和端口
```

![](/images/posts/Devops/Devops-01-自动化运维平台/10.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/11.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/12.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/13.png)

### 3. 配置工作容器

![](/images/posts/Devops/Devops-01-自动化运维平台/15.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/16.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/17.png)



```sh
[root@master01 jenkins-slave]# docker pull jenkins/inbound-agent:4.11-1-jdk11
[root@master01 jenkins-slave]# docker tag jenkins/inbound-agent:4.11-1-jdk11 11.0.1.5/dev-ops/inbound-agent:4.11-1-jdk11
[root@master01 jenkins-slave]# docker push 11.0.1.5/dev-ops/inbound-agent:4.11-1-jdk11
```

![](/images/posts/Devops/Devops-01-自动化运维平台/18.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/19.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/20.png)



![](/images/posts/Devops/Devops-01-自动化运维平台/21.png)

### 4. 测试jenkins-slave

![](/images/posts/Devops/Devops-01-自动化运维平台/22.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/23.png)

```sh
pipeline {
        // 指定任务在哪个集群节点上运行
       agent {
         label 'jenkins-jnlp-slave'  // 这个就是我们上面定义的那个标签
       }
       stages {
       stage('测试流水线') {
         steps {
              container('jenkins-slave') {    // 指定我们自定镜像的容器
              sh 'kubectl get pods -A'     // 因为要执行这些动作，只有我们定义的那个镜像才有这些命令
              sh 'docker ps'
               }
        }
        }
    }
}
```

![](/images/posts/Devops/Devops-01-自动化运维平台/24.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/25.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/26.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/27.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/28.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/29.png)

## 三、 流水线脚本

java-demo 项目包: wget http://blog.tianxiang.love/data/java-demo.zip

### 1. Jenkinsfile

使用以下脚本前请配置好 harbor 仓库，以及流水线基于参数化构建；git参数；tag 标签

```sh
 pipeline {

        // 指定任务在哪个集群节点上运行
       agent {
         label 'jenkins-jnlp-slave'
       }

        // 声明全局变量，方便后面使用
        environment{
                harborUser = 'admin'               //仓库用户名
                harborPasswd = 'Harbor12345'       //仓库密码
                harborAddres = '11.0.1.5'          //仓库地址
                harborRepo = 'library'             //仓库名称
                project_yaml = 'java-demo.yaml'    //yaml名称
                namespace = 'demo'                 //提交的命名空间

                GITLAB_COMMIT_SHORT_ID = sh(script: 'git rev-parse --short HEAD',returnStdout: true).trim() //commit短ID
        }

                stages {

                stage('拉取git仓库代码') {
                        steps {
                        container('jenkins-slave') {
                        checkout scm
                        }
                        }
                }
                stage('通过maven构建项目') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mvn clean package -DskipTests'

                        }
                        }
                }
                stage('通过Docker制作自定义镜像') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mv ./target/*.jar ./docker/'
                                sh 'docker build -t ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ./docker'

                        }
                        }
                }
                stage('将自定义镜像推送到Harbor') {
                        steps {
                                container('jenkins-slave') {
                                sh 'docker login ${harborAddres} -u ${harborUser} -p ${harborPasswd}'
                                sh 'docker tag ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'
                                sh 'docker push ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'

                        }
                        }
                }

                stage('执行 kubectl apply 命令提交资源') {
                steps {
                        timeout(time: 1,unit: 'MINUTES'){  // 1 分钟超时时间
                        container('jenkins-slave') {
                        sh 'sed -i "s#image:.*#image: ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}#g" ${project_yaml}'
                        sh 'sed -i "s#namespace:.*#namespace: ${namespace}#g" ${project_yaml}'
                        sh 'cat ${project_yaml}'
                        sh 'if [[ ${namespace} == `kubectl get ns |awk \'$1=="${namespace}"{print $1}\'` ]];then kubectl apply -f ${project_yaml};else kubectl create ns ${namespace};kubectl apply -f ${project_yaml};fi'
                        sh 'sleep 10 && kubectl get pods,svc -n ${namespace}'
                        }
                        }
                        }
                }
        }
}
```

![](/images/posts/Devops/Devops-01-自动化运维平台/30.png)

![](F:\13-学习\8-Devops-自动化运维平台\/images/posts/Devops/Devops-01-自动化运维平台/31.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/32.png)

```sh
[root@master01 java-demo]# ssh-keygen -t rsa -b 2048 -C "2099637909@qq.com"
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): y
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Passphrases do not match.  Try again.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in y.
Your public key has been saved in y.pub.
The key fingerprint is:
SHA256:vGEoxr9/G2klnPLECJa7pPFKsU+elSt1S8bSA6mpTAc 2099637909@qq.com
The key's randomart image is:
+---[RSA 2048]----+
|                 |
|       .         |
|      +  .       |
|   .E. =o+ .     |
|    *.+oS+* .    |
|   ..X+ooBB+     |
|   o+o=.+==o     |
|   .o=.+ oo.     |
|    . =oo...     |
+----[SHA256]-----+
[root@master01 java-demo]# cat ~/.ssh/id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC22wxkJSOacdPhXXM5xwerx8RpgOZo5cm0ijtdRpNOkWjaJcmEn5ohw38BYKaXrRv6TmV8BXauBnNcU0IJi9tjVJ3dN0hQgxhWhCenOel+v8cPjvBbeq3/HhZVU1o5jH6exWetdXdZBC6JbUK3JvYIRRahigxUDxsf+zElKxJSgYJ2vinnRhSUQ9s+ZqLat29wcnkDq0OmkVV065XefBp2LuLdk8yJb0zIPnhhycP/P2Bu1HM8i+s6v7txOqh/opxxUtHWVhMWH4W9nr6yk7/aIzcVwOeV7bhBu6B1TYgovtFVTA+dCGRayUGkrqyR72MPsrte6YlKhH1j/lrNFf/f 2099637909@qq.com
```

![](/images/posts/Devops/Devops-01-自动化运维平台/33.png)

> 我的 java-demo
>
> 链接：https://pan.baidu.com/s/1bwTQhJNxKC3KsW5JFqgf4A?pwd=wsj7
>
> 提取码：wsj7

```sh
[root@master01 java-demo]# ls
docker  Jenkinsfile  mvnw  mvnw.cmd  pipeline-demo.yaml  pom.xml  src  target
[root@master01 java-demo]# docker pull zhentianxiang/jre8:8u112
[root@master01 java-demo]# docker tag zhentianxiang/jre8:8u112 11.0.1.5/library/jre8:8u112
[root@master01 java-demo]# docker push 11.0.1.5/library/jre8:8u112
[root@master01 java-demo]# vim docker/Dockerfile
FROM 11.0.1.5/library/jre8:8u112
COPY demo-01.jar /usr/local
WORKDIR /usr/local
CMD java -jar -Xms128m -Xmx128m demo-01.jar
[root@master01 java-demo]# git config --global user.name "Administrator"
[root@master01 java-demo]# git config --global user.email "2099637909@qq.com"
[root@master01 java-demo]# git remote add origin ssh://git@gitlab.demo.com:30022/root/java-demo.git
[root@master01 java-demo]# git init
初始化空的 Git 版本库于 /data/kubernetes/demo/java-demo/.git/
[root@master01 java-demo]# git add .
[root@master01 java-demo]# git commit -m 'Initial commit'
[root@master01 java-demo]# git push origin master
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:SVUDQm25HBkcH6xjgHEcGTrb3Wz3UNSh2Yp+KxCJtgE.
Please contact your system administrator.
Add correct host key in /root/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /root/.ssh/known_hosts:11
ECDSA host key for [gitlab.demo.com]:30022 has changed and you have requested strict checking.
Host key verification failed.
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
[root@master01 java-demo]# rm -rf ~/.ssh/known_hosts
[root@master01 java-demo]# git push origin master
The authenticity of host '[gitlab.demo.com]:30022 ([11.0.1.110]:30022)' can't be established.
ECDSA key fingerprint is SHA256:SVUDQm25HBkcH6xjgHEcGTrb3Wz3UNSh2Yp+KxCJtgE.
ECDSA key fingerprint is MD5:2b:4f:70:cf:4d:b3:f8:5a:a3:56:73:ad:45:3d:da:97.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '[gitlab.demo.com]:30022,[11.0.1.110]:30022' (ECDSA) to the list of known hosts.
Counting objects: 34, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (22/22), done.
Writing objects: 100% (34/34), 60.96 KiB | 0 bytes/s, done.
Total 34 (delta 0), reused 0 (delta 0)
To ssh://git@gitlab.demo.com:30022/root/java-demo.git
 * [new branch]      master -> master
```

![](/images/posts/Devops/Devops-01-自动化运维平台/34.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/35.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/36.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/37.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/38.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/39.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/40.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/41.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/42.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/43.png)

## 四、配置触发器

### 1. Jenkins 配置触发器

配置文件中新增加发送消息通知的代码

```sh
 pipeline {

        // 指定任务在哪个集群节点上运行
       agent {
         label 'jenkins-jnlp-slave'
       }

        // 声明全局变量，方便后面使用
        environment{
                harborUser = 'admin'               //仓库用户名
                harborPasswd = 'Harbor12345'       //仓库密码
                harborAddres = '11.0.1.5'          //仓库地址
                harborRepo = 'library'             //仓库名称
                project_yaml = 'java-demo.yaml'    //yaml名称
                namespace = 'demo'                 //提交的命名空间

                GITLAB_COMMIT_SHORT_ID = sh(script: 'git rev-parse --short HEAD',returnStdout: true).trim() //commit短ID
        }

                stages {

                stage('拉取git仓库代码') {
                        steps {
                        container('jenkins-slave') {
                        checkout scm
                        }
                        }
                }
                stage('通过maven构建项目') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mvn clean package -DskipTests'

                        }
                        }
                }
                stage('通过Docker制作自定义镜像') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mv ./target/*.jar ./docker/'
                                sh 'docker build -t ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ./docker'

                        }
                        }
                }
                stage('将自定义镜像推送到Harbor') {
                        steps {
                                container('jenkins-slave') {
                                sh 'docker login ${harborAddres} -u ${harborUser} -p ${harborPasswd}'
                                sh 'docker tag ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'
                                sh 'docker push ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'

                        }
                        }
                }

                stage('执行 kubectl apply 命令提交资源') {
                steps {
                        container('jenkins-slave') {
                        sh 'sed -i "s#image:.*#image: ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}#g" ${project_yaml}'
                        sh 'sed -i "s#namespace:.*#namespace: ${namespace}#g" ${project_yaml}'
                        sh 'cat ${project_yaml}'
                        sh 'if [[ ${namespace} == `kubectl get ns |awk \'$1=="${namespace}"{print $1}\'` ]];then kubectl apply -f ${project_yaml};else kubectl create ns ${namespace};kubectl apply -f ${project_yaml};fi'
                        sh 'sleep 10 && kubectl get pods,svc -n ${namespace}'
                        }
                        }
                }
        }

        post {
            success {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建成功: ${JOB_NAME}! \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString}"]
                )
            }
            failure {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建失败: ${JOB_NAME}! \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString}"]
                )
            }

        }
}
```



![](/images/posts/Devops/Devops-01-自动化运维平台/44.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/45.png)

### 2. gitlab 配置 webhook

![](/images/posts/Devops/Devops-01-自动化运维平台/46.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/47.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/48.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/49.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/50.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/51.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/52.png)

### 4. DingDing消息通知

由于我在安装完 ding talk 插件够不知道为什么丢失了一些功能，包括我的一些任务，所以我直接把Jenkins版本换成了最新的了

![](/images/posts/Devops/Devops-01-自动化运维平台/55.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/56.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/57.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/58.png)

由于Jenkins版本发生变更，所以需要重新配置kubernetes

![](/images/posts/Devops/Devops-01-自动化运维平台/59.png)

这里我以为换Jenkins版本后可以加入Jenkins通道的配置了，结果还是不行

![](/images/posts/Devops/Devops-01-自动化运维平台/60.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/61.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/62.png)

测试一个任务，看一下该版本的master的slave应该使用哪个镜像

![](/images/posts/Devops/Devops-01-自动化运维平台/63.png)

```sh
[root@master01 jenkins-slave]# docker pull jenkins/inbound-agent:3107.v665000b_51092-4
[root@master01 jenkins-slave]# docker tag jenkins/inbound-agent:3107.v665000b_51092-4 11.0.1.5/dev-ops/jenkins/inbound-agent:3107.v665000b_51092-4
[root@master01 jenkins-slave]# docker push 11.0.1.5/dev-ops/jenkins/inbound-agent:3107.v665000b_51092-4
```

继续配置 pod templates

![](/images/posts/Devops/Devops-01-自动化运维平台/64.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/65.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/66.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/67.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/68.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/69.png)

继续测试钉钉消息通知

![](/images/posts/Devops/Devops-01-自动化运维平台/70.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/71.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/72.png)

### 五、多分枝构建

```sh
 pipeline {

        // 指定任务在哪个集群节点上运行
       agent {
         label 'jenkins-jnlp-slave'
       }

        // 声明全局变量，方便后面使用
        environment{
                harborUser = 'admin'               //仓库用户名
                harborPasswd = 'Harbor12345'       //仓库密码
                harborAddres = '11.0.1.5'          //仓库地址
                harborRepo = 'library'             //仓库名称
                project_yaml = 'java-demo.yaml'    //yaml名称
                namespace = 'demo'                 //提交的命名空间

                GITLAB_COMMIT_SHORT_ID = sh(script: 'git rev-parse --short HEAD',returnStdout: true).trim() //commit短ID
        }

                stages {

                stage('拉取git仓库代码') {
                        steps {
                        container('jenkins-slave') {
                        checkout scm
                        }
                        }
                }
                stage('通过maven构建项目') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mvn clean package -DskipTests'

                        }
                        }
                }
                stage('通过Docker制作自定义镜像') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mv ./target/*.jar ./docker/'
                                sh 'docker build -t ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ./docker'

                        }
                        }
                }
                stage('将自定义镜像推送到Harbor') {
                        steps {
                                container('jenkins-slave') {
                                sh 'docker login ${harborAddres} -u ${harborUser} -p ${harborPasswd}'
                                sh 'docker tag ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'
                                sh 'docker push ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'

                        }
                        }
                }

                stage('执行 kubectl apply 命令提交资源') {
                steps {
                        container('jenkins-slave') {
                        sh 'sed -i "s#image:.*#image: ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}#g" ${project_yaml}'
                        sh 'sed -i "s#namespace:.*#namespace: ${namespace}#g" ${project_yaml}'
                        sh 'cat ${project_yaml}'
                        sh 'if [[ ${namespace} == `kubectl get ns |awk \'$1=="${namespace}"{print $1}\'` ]];then kubectl apply -f ${project_yaml};else kubectl create ns ${namespace};kubectl apply -f ${project_yaml};fi'
                        sh 'sleep 10 && kubectl get pods,svc -n ${namespace}'
                        }
                        }
                }
        }

        post {
            success {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建成功: ${JOB_NAME}! \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString}"]
                )
            }
            failure {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建失败: ${JOB_NAME}! \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString}"]
                )
            }

        }
}
```



### 1. 新建分支

```sh
[root@master01 java-demo]# git branch deploy
[root@master01 java-demo]# git branch
  deploy
* master
[root@master01 java-demo]# git checkout deploy
切换到分支 'deploy'
[root@master01 java-demo]# vim src/main/java/com/example/demo01/controller/TestController.java
[root@master01 java-demo]# git add .
[root@master01 java-demo]# git commit -m "Initial commit"
[deploy 93a5745] Initial commit
 1 file changed, 1 insertion(+), 1 deletion(-)
[root@master01 java-demo]# git push origin deploy
Counting objects: 19, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (6/6), done.
Writing objects: 100% (10/10), 729 bytes | 0 bytes/s, done.
Total 10 (delta 2), reused 0 (delta 0)
remote:
remote: To create a merge request for deploy, visit:
remote:   http://gitlab.demo.com/root/java-demo/-/merge_requests/new?merge_request%5Bsource_branch%5D=deploy
remote:
To ssh://git@gitlab.demo.com:30022/root/java-demo.git
 * [new branch]      deploy -> deploy
```

### 2. 新建流水线

![](/images/posts/Devops/Devops-01-自动化运维平台/73.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/74.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/75.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/76.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/77.png)

### 3. 通知 gitlab 构建状态

```sh
pipeline {

        // 指定任务在哪个集群节点上运行
       agent {
         label 'jenkins-jnlp-slave'
       }

        // 声明全局变量，方便后面使用
        environment{
                harborUser = 'admin'               //仓库用户名
                harborPasswd = 'Harbor12345'       //仓库密码
                harborAddres = '11.0.1.5'          //仓库地址
                harborRepo = 'library'             //仓库名称
                project_yaml = 'java-demo.yaml'    //yaml名称
                namespace = 'demo'                 //提交的命名空间

                GITLAB_COMMIT_SHORT_ID = sh(script: 'git rev-parse --short HEAD',returnStdout: true).trim() //commit短ID
        }

        options {
            gitLabConnection( 'gitlab') //系统配置中 gitlab 配置项名称
        }

        triggers {
        gitlab(triggerOnPush: true, triggerOnMergeRequest: true, branchFilterType:'All',
        secretToken: "xyrsYe7nV-ZWPg2bQMPK")        //在gitlab中配置的jenkins API TOKEN
        }

        stages {

                stage('拉取git仓库代码') {
                        steps {
                                container('jenkins-slave') {
                                checkout scm

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS = env.STAGE_NAME + "✅..." + env.TAB_STR
                                }
                                }
                        }
                }
                stage('通过maven构建项目') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mvn clean package -DskipTests'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }
                        }
                }
                stage('通过Docker制作自定义镜像') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mv ./target/*.jar ./docker/'
                                sh 'docker build -t ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ./docker'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }

                        }
                }
                stage('将自定义镜像推送到Harbor') {
                        steps {
                                container('jenkins-slave') {
                                sh 'docker login ${harborAddres} -u ${harborUser} -p ${harborPasswd}'
                                sh 'docker tag ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'
                                sh 'docker push ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }

                        }
                }
                stage('执行 kubectl apply 命令提交资源') {
                        steps {
                                container('jenkins-slave') {
                                sh 'sed -i "s#image:.*#image: ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}#g" ${project_yaml}'
                                sh 'sed -i "s#namespace:.*#namespace: ${namespace}#g" ${project_yaml}'
                                sh 'cat ${project_yaml}'
                                sh 'if [[ ${namespace} == `kubectl get ns |awk \'$1=="${namespace}"{print $1}\'` ]];then kubectl apply -f ${project_yaml};else kubectl create ns ${namespace};kubectl apply -f ${project_yaml};fi'
                                sh 'sleep 10 && kubectl get pods,svc -n ${namespace}'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }
                        }
                }
        }

        post {
            success {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建成功: ${JOB_NAME}! \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString} \n- 构建任务: ${BUILD_TASKS}"]
                )
            }
            failure {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建失败: ${JOB_NAME}! \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString} \n- 构建任务: ${BUILD_TASKS}"]
                )
            }

        }
}
```

```sh
[root@master01 java-demo]# vim Jenkinsfile
[root@master01 java-demo]# git add .
[root@master01 java-demo]# git commit -m "Initial commit"
[deploy b65d867] Initial commit
 1 file changed, 13 insertions(+), 4 deletions(-)
[root@master01 java-demo]# git push origin deploy
Counting objects: 5, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 589 bytes | 0 bytes/s, done.
Total 3 (delta 2), reused 0 (delta 0)
remote:
remote: To create a merge request for deploy, visit:
remote:   http://gitlab.demo.com/root/java-demo/-/merge_requests/new?merge_request%5Bsource_branch%5D=deploy
remote:
To ssh://git@gitlab.demo.com:30022/root/java-demo.git
   20841e2..b65d867  deploy -> deploy
```

![](/images/posts/Devops/Devops-01-自动化运维平台/78.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/79.png)

## 三、部署 sonarqube

### 1. 准备 yaml 文件

```sh
[root@master01 sonarqube]# cat sonarqube-dep.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sonarqube
  namespace: dev-ops
  labels:
    app: sonarqube
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sonarqube
  template:
    metadata:
      labels:
        app: sonarqube
    spec:
      initContainers:
      - name: init-sysctl
        image: busybox:latest
        imagePullPolicy: IfNotPresent
        command: ["sysctl", "-w", "vm.max_map_count=262144"]
        securityContext:
          privileged: true
      containers:
      - name: sonarqube
        image: sonarqube:8.9.6-community
        ports:
        - containerPort: 9000
        env:
        - name: SONARQUBE_JDBC_USERNAME
          value: "gitlab"
        - name: SONARQUBE_JDBC_PASSWORD
          value: "passw0rd"
        - name: SONARQUBE_JDBC_URL
          value: "jdbc:postgresql://postgresql:5432/sonardb"
        resources:
          limits:
            cpu: 1000m
            memory: 2Gi
          requests:
            cpu: 500m
            memory: 1Gi
        livenessProbe:
          httpGet:
            path: /sessions/new
            port: 9000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /sessions/new
            port: 9000
          initialDelaySeconds: 60
          periodSeconds: 30
          failureThreshold: 6
        volumeMounts:
        - mountPath: /etc/localtime
          name: host-time
          readOnly: true  
        - mountPath: /opt/sonarqube/conf
          name: data
          subPath: conf
        - mountPath: /opt/sonarqube/data
          name: data
          subPath: data
        - mountPath: /opt/sonarqube/extensions
          name: data
          subPath: extensions
      volumes:
      - name: host-time
        hostPath:
          path: /etc/localtime
      - name: data
        persistentVolumeClaim:
          claimName: sonarqube-data-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: sonarqube
  namespace: dev-ops
  labels:
    app: sonarqube
spec:
  type: NodePort
  ports:
    - name: sonarqube
      port: 9000
      targetPort: 9000
      nodePort: 30090
      protocol: TCP
  selector:
    app: sonarqube
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: sonarqube-ingress
  namespace: dev-ops
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
  labels:
    name: sonarqube-ingress
spec:
  rules:
  - host: sonarqube.demo.com
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: sonarqube
            port:
              number: 9000
```

### 2. 简单配置

我这里已经登录进来了，你们第一次登录会提示输入用户密码，默认都是admin

![](/images/posts/Devops/Devops-01-自动化运维平台/80.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/81.png)

### 3 本地代码测试

二进制包下载地址：https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/

```sh
[root@master01 sonarqube]# wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip
[root@master01 sonarqube]# unzip sonar-scanner-cli-4.7.0.2747-linux.zip
[root@master01 sonarqube]# mv sonar-scanner-4.7.0.2747-linux/ sonar-scanner
[root@master01 sonarqube]# vim sonar-scanner/conf/sonar-scanner.properties
#Configure here general information about the environment, such as SonarQube server connection details for example
#No information about specific project should appear here

#----- Default SonarQube server
#sonar.host.url=http://localhost:9000
sonar.host.url=http://sonarqube.demo.com/
sonar.login = admin
sonar.password = tx010910.
#----- Default source code encoding
#sonar.sourceEncoding=UTF-8
```

使用本地代码进行测试

```sh
[root@master01 java-demo]# ls
docker  Jenkinsfile  mvnw  mvnw.cmd  pipeline-demo.yaml  pom.xml  src
[root@master01 java-demo]# /data/kubernetes/sonarqube/sonar-scanner/bin/sonar-scanner -Dsonar.source=./ -Dsonar.projectname=java-demo -Dsonar.projectKey=java-demo -Dsonar.java.binaries=./target
INFO: SCM Publisher 4 source files to be analyzed
INFO: SCM Publisher 4/4 source files have been analyzed (done) | time=151ms
INFO: CPD Executor 3 files had no CPD blocks
INFO: CPD Executor Calculating CPD for 0 files
INFO: CPD Executor CPD calculation finished (done) | time=0ms
INFO: Analysis report generated in 57ms, dir size=99 KB
INFO: Analysis report compressed in 12ms, zip size=18 KB
INFO: Analysis report uploaded in 943ms
INFO: ANALYSIS SUCCESSFUL, you can browse http://sonarqube.demo.com/dashboard?id=jenkins-test
INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report
INFO: More about the report processing at http://sonarqube.demo.com/api/ce/task?id=AYbP8Sa5EgoKFIKPuCWI
INFO: Analysis total time: 7.727 s
INFO: ------------------------------------------------------------------------
INFO: EXECUTION SUCCESS
INFO: ------------------------------------------------------------------------
INFO: Total time: 8.852s
INFO: Final Memory: 9M/34M
INFO: ------------------------------------------------------------------------
```

### 4. jenkins 部署插件

![](/images/posts/Devops/Devops-01-自动化运维平台/82.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/83.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/84.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/85.png)

### 5. Jenkins 配置 sonarqube

![](/images/posts/Devops/Devops-01-自动化运维平台/86.png)



![](/images/posts/Devops/Devops-01-自动化运维平台/87.png)

### 6. 流水线测试

项目根目录下创建一个文件

```sh
[root@master01 java-demo]# cat sonar-project.properties
sonar.source=./
sonar.projectname=java-demo
sonar.projectKey=java-demo
sonar.java.binaries=./target
sonar.host.url=http://sonarqube.demo.com/
```

第一个脚本执行代码扫描同时并进行单元测试，通过后直接通过

第二个脚本会进行判断代码扫描能否达到预期效果，达到后才能通过

```sh
pipeline {

        // 指定任务在哪个集群节点上运行
       agent {
         label 'jenkins-jnlp-slave'
       }

        // 声明全局变量，方便后面使用
        environment{
                harborUser = 'admin'               //仓库用户名
                harborPasswd = 'Harbor12345'       //仓库密码
                harborAddres = '11.0.1.5'          //仓库地址
                harborRepo = 'library'             //仓库名称
                project_yaml = 'java-demo.yaml'    //yaml名称
                namespace = 'demo'                 //提交的命名空间

                GITLAB_COMMIT_SHORT_ID = sh(script: 'git rev-parse --short HEAD',returnStdout: true).trim() //commit短ID



        }

        options {
            gitLabConnection( 'gitlab') //系统配置中 gitlab 配置项名称
        }

        triggers {
        gitlab(triggerOnPush: true, triggerOnMergeRequest: true, branchFilterType:'All',
        secretToken: "xyrsYe7nV-ZWPg2bQMPK")        //在gitlab中配置的jenkins API TOKEN
        }

        stages {

                stage('拉取git仓库代码') {
                        steps {
                                container('jenkins-slave') {
                                checkout scm

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS = env.STAGE_NAME + "✅..." + env.TAB_STR
                                }
                                }
                        }
                }
                stage('通过maven构建项目') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mvn clean package -DskipTests'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                   env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }
                        }
                }
                stage('代码测试验证') {
                        failFast true
                        parallel {
                         stage('Unit Test') {
                         steps {
                             container('jenkins-slave') {
                             echo "Unit Test Stage Skip..."
                            }
                            }
                        }
                         stage('Code Scan') {
                         steps {
                                container('jenkins-slave') {
                                sh 'sonar-scanner -X'
                                }
                            }
                        }
                    }
                }
                stage('通过Docker制作自定义镜像') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mv ./target/*.jar ./docker/'
                                sh 'docker build -t ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ./docker'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }

                        }
                }
                stage('将自定义镜像推送到Harbor') {
                        steps {
                                container('jenkins-slave') {
                                sh 'docker login ${harborAddres} -u ${harborUser} -p ${harborPasswd}'
                                sh 'docker tag ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'
                                sh 'docker push ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }

                        }
                }
                stage('执行 kubectl apply 命令提交资源') {
                        steps {
                                container('jenkins-slave') {
                                sh 'sed -i "s#image:.*#image: ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}#g" ${project_yaml}'
                                sh 'sed -i "s#namespace:.*#namespace: ${namespace}#g" ${project_yaml}'
                                sh 'cat ${project_yaml}'
                                sh 'if [[ ${namespace} == `kubectl get ns |awk \'$1=="${namespace}"{print $1}\'` ]];then kubectl apply -f ${project_yaml};else kubectl create ns ${namespace};kubectl apply -f ${project_yaml};fi'
                                sh 'sleep 10 && kubectl get pods,svc -n ${namespace}'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }
                        }
                }
        }

        post {
            success {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建成功: ${JOB_NAME}! \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString} \n- 构建任务: ${BUILD_TASKS}"]
                )
            }
            failure {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建失败: ${JOB_NAME}! \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString} \n- 构建任务: ${BUILD_TASKS}"]
                )
            }

        }
}
```

脚本二

```sh
pipeline {

        // 指定任务在哪个集群节点上运行
       agent {
         label 'jenkins-jnlp-slave'
       }

        // 声明全局变量，方便后面使用
        environment{
                harborUser = 'admin'               //仓库用户名
                harborPasswd = 'Harbor12345'       //仓库密码
                harborAddres = '11.0.1.5'          //仓库地址
                harborRepo = 'library'             //仓库名称
                project_yaml = 'java-demo.yaml'    //yaml名称
                namespace = 'demo'                 //提交的命名空间

                GITLAB_COMMIT_SHORT_ID = sh(script: 'git rev-parse --short HEAD',returnStdout: true).trim() //commit短ID
        }

        options {
            gitLabConnection( 'gitlab') //系统配置中 gitlab 配置项名称
        }

        triggers {
        gitlab(triggerOnPush: true, triggerOnMergeRequest: true, branchFilterType:'All',
        secretToken: "xyrsYe7nV-ZWPg2bQMPK")        //在gitlab中配置的jenkins API TOKEN
        }

        stages {

                stage('Gitlab拉取代码') {
                        steps {
                                container('jenkins-slave') {
                                checkout scm

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS = env.STAGE_NAME + "✅..." + env.TAB_STR
                                }
                                }
                        }
                }
                stage('maven构建') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mvn clean package -DskipTests'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }
                        }
                }
                stage('单元测试+代码扫描') {
                        failFast true
                        parallel {
                         stage('Unit Test') {
                         steps {
                             container('jenkins-slave') {
                             echo "Unit Test Stage Skip..."
                            }
                            }
                        }
                         stage('Code Scan') {
                         steps {
                                container('jenkins-slave') {
                                withSonarQubeEnv('sonarqube') {
                                sh 'sonar-scanner -X'
                                sh 'sleep 3'
                                }
                                }
                                    script {
                                        timeout(1) {
                                            def qg = withForQualityGate('sonarqube')
                                                if (qg.status != 'OK') {
                                                    error "未通过Sonarqube代码质量检查,请及时修改! failure: ${qg.status}"
                                            }

                                      }
                                 }
                            }
                        }
                    }
                }
                stage('自定义镜像') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mv ./target/*.jar ./docker/'
                                sh 'docker build -t ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ./docker'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }

                        }
                }
                stage('镜像推送') {
                        steps {
                                container('jenkins-slave') {
                                sh 'docker login ${harborAddres} -u ${harborUser} -p ${harborPasswd}'
                                sh 'docker tag ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'
                                sh 'docker push ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }

                        }
                }
                stage('k8s交付资源') {
                        steps {
                                container('jenkins-slave') {
                                sh 'sed -i "s#image:.*#image: ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}#g" ${project_yaml}'
                                sh 'sed -i "s#namespace:.*#namespace: ${namespace}#g" ${project_yaml}'
                                sh 'cat ${project_yaml}'
                                sh 'if [[ ${namespace} == `kubectl get ns |awk \'$1=="${namespace}"{print $1}\'` ]];then kubectl apply -f ${project_yaml};else kubectl create ns ${namespace};kubectl apply -f ${project_yaml};fi'
                                sh 'sleep 10 && kubectl get pods,svc -n ${namespace}'

                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                script {
                                    env.BUILD_TASKS += env.STAGE_NAME + "✅..." + env.TAB_STR
                                }

                                }
                        }
                }
        }

        post {
            success {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建成功: ${JOB_NAME}! \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString} \n- 构建任务: ${BUILD_TASKS}"]
                )
            }
            failure {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建失败: ${JOB_NAME}! \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString} \n- 构建任务: ${BUILD_TASKS}"]
                )
            }

        }
}
```

![](/images/posts/Devops/Devops-01-自动化运维平台/88.png)

## 四、多环境CICD部署

### 1. 准备流水线脚本

使用when关键字，配合正则表达式，实现分支的过滤选择：
```sh
pipeline {
        // 指定任务在哪个集群节点上运行
       agent {
         label 'jenkins-jnlp-slave'
       }

    stages {
        stage('Example Build') {
            steps {
                echo 'Hello World'
            }
        }
        stage('Example Deploy') {
            when {
                expression { BRANCH_NAME ==~ "deploy" }
            }
            steps {
                echo 'Deploying to deploy env'
            }
        }
    }
}
```

java-demo 流水线脚本，该脚本中的镜像构建分为生产环境镜像构建，开发测试环境镜像不区分，以及开发环境部署、测试环境部署、生产环境部署，并且还会检查pod启动情况
```sh
pipeline {

        // 指定任务在哪个集群节点上运行
       agent {
         label 'jenkins-jnlp-slave'
       }

        // 声明全局变量，方便后面使用
        environment{
                harborUser = 'admin'               //仓库用户名
                harborPasswd = 'Harbor12345'       //仓库密码
                harborAddres = '11.0.1.5'          //仓库地址
                harborRepo = 'library'             //仓库名称
                project_yaml = 'java-demo.yaml'    //yaml名称
                dev_namespace = 'dev'              //开发环境命名空间
                test_namespace = 'test'            //测试环境命名空间
                prod_namespace = 'prod'            //生产环境命名空间
                
               
                GITLAB_COMMIT_SHORT_ID = sh(script: 'git rev-parse --short HEAD',returnStdout: true).trim() //commit短ID



        }
        
        options {
            gitLabConnection( 'gitlab') //系统配置中 gitlab 配置项名称
        }
        
        triggers {
        gitlab(triggerOnPush: true, triggerOnMergeRequest: true, branchFilterType:'All',
        secretToken: "xyrsYe7nV-ZWPg2bQMPK")        //在gitlab中配置的jenkins API TOKEN
        }

        stages {

                stage('拉取git仓库代码') {
                        steps {
                                container('jenkins-slave') {
                                checkout scm
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                }
                        }
                }
                stage('通过maven构建项目') {
                        steps {
                                container('jenkins-slave') {
                                sh 'mvn clean package -DskipTests'
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                }
                        }
                }
                stage('代码测试验证') {
                        failFast true
                        parallel {
                         stage('Unit Test') {
                         steps {
                             container('jenkins-slave') {
                             echo "Unit Test Stage Skip..."
                            }
                            }
                        }
                         stage('Code Scan') {
                         steps {
                                container('jenkins-slave') {
                                sh 'sonar-scanner -X'
                                }
                            }
                        }
                    }
                }
                stage('生产环境构建镜像') {
                     when {
                          expression { BRANCH_NAME ==~ /v.*/ }
                     }
                        steps {
                                container('jenkins-slave') {
                                sh 'mv ./target/*.jar ./docker/'
                                sh 'docker build -t ${JOB_NAME}:${TAG_NAME} ./docker'
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                }

                        }
                }
                stage('开发测试环境构建镜像') {
                     when {
                          expression { BRANCH_NAME ==~ "master|deploy" }
                     }
                        steps {
                                container('jenkins-slave') {
                                sh 'mv ./target/*.jar ./docker/'
                                sh 'docker build -t ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ./docker'
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                }

                        }
                }
                stage('将开发测试环境镜像推送到Harbor') {
                     when {
                          expression { BRANCH_NAME ==~ "master|deploy" }
                     }
                        steps {
                                container('jenkins-slave') {
                                sh 'docker login ${harborAddres} -u ${harborUser} -p ${harborPasswd}'
                                sh 'docker tag ${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID} ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'
                                sh 'docker push ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}'
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                }

                        }
                }
                stage('将生产环境镜像推送到Harbor') {
                     when {
                          expression { BRANCH_NAME ==~ /v.*/ }
                     }
                        steps {
                                container('jenkins-slave') {
                                sh 'docker login ${harborAddres} -u ${harborUser} -p ${harborPasswd}'
                                sh 'docker tag ${JOB_NAME}:${TAG_NAME} ${harborAddres}/${harborRepo}/${JOB_NAME}:${TAG_NAME}'
                                sh 'docker push ${harborAddres}/${harborRepo}/${JOB_NAME}:${TAG_NAME}'
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                }

                        }
                }
                stage('开发环境k8s部署') {
                     when {
                          expression { BRANCH_NAME ==~ "deploy" }
                     }
                        steps {
                                container('jenkins-slave') {
                                sh '''
                                sed -i "s#image:.*#image: ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}#g" ${project_yaml}
                                sed -i "s#namespace:.*#namespace: ${dev_namespace}#g" ${project_yaml}
                                cat ${project_yaml}'''
                                sh '''
                                if kubectl get namespace ${dev_namespace} > /dev/null 2>&1; then
                                   echo "Namespace ${dev_namespace} already exists"
                                   kubectl apply -f ${project_yaml}
                                else
                                   echo "Namespace ${dev_namespace} does not exist, creating it now..."
                                   kubectl create namespace ${dev_namespace}
                                   echo "Namespace ${dev_namespace} created successfully!"
                                   kubectl apply -f ${project_yaml}
                                fi
                                '''
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                }
                            }
                }
                stage('开发环境检查pod启动') {
                     when {
                          expression { BRANCH_NAME ==~ "deploy" }
                    }
                    steps {
                             container('jenkins-slave') {
                             script {
                             timeout(time: 3, unit: 'MINUTES') {
                                 def allPodsRunning = false
                                 while (!allPodsRunning) {
                                    def podPhase = sh(script: 'kubectl get pods -n ${dev_namespace} -o jsonpath="{range .items[*]}{.status.phase}{\\"\\n\\"}{end}"', returnStdout: true).trim()
                                    def podStatusList = podPhase.tokenize("\n")
                                    allPodsRunning = true;
                                    for (String status : podStatusList) {
                                        if (!status.equals("Running")) {
                                             allPodsRunning = false;
                                             break;
                                       }
                                    }

                                   if (allPodsRunning) {
                                       echo "All pods are running!"
                                       break
                                   } else {
                                       echo "Not all pods are running, waiting 10 seconds and retrying..."
                                       sleep 10
                                     }
                                }
                            }
                         }
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                      }
                   }
                }
                stage('测试环境k8s部署') {
                     when {
                          expression { BRANCH_NAME ==~ "master" }
                     }
                        steps {
                                container('jenkins-slave') {
                                sh '''
                                sed -i "s#image:.*#image: ${harborAddres}/${harborRepo}/${JOB_NAME}:${GITLAB_COMMIT_SHORT_ID}#g" ${project_yaml}
                                sed -i "s#namespace:.*#namespace: ${test_namespace}#g" ${project_yaml}
                                cat ${project_yaml}'''
                                sh '''
                                if kubectl get namespace ${test_namespace} > /dev/null 2>&1; then
                                   echo "Namespace ${test_namespace} already exists"
                                   kubectl apply -f ${project_yaml}
                                else
                                   echo "Namespace ${test_namespace} does not exist, creating it now..."
                                   kubectl create namespace ${test_namespace}
                                   echo "Namespace ${test_namespace} created successfully!"
                                   kubectl apply -f ${project_yaml}
                                fi
                                '''
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                }
                            }
                }
                stage('测试环境检查pod启动') {
                     when {
                          expression { BRANCH_NAME ==~ "master" }
                    }
                    steps {  
                             container('jenkins-slave') {
                             script {
                             timeout(time: 3, unit: 'MINUTES') {
                                 def allPodsRunning = false
                                 while (!allPodsRunning) {
                                    def podPhase = sh(script: 'kubectl get pods -n ${test_namespace} -o jsonpath="{range .items[*]}{.status.phase}{\\"\\n\\"}{end}"', returnStdout: true).trim()
                                    def podStatusList = podPhase.tokenize("\n")
                                    allPodsRunning = true;
                                    for (String status : podStatusList) {
                                        if (!status.equals("Running")) {
                                             allPodsRunning = false;
                                             break;
                                       }
                                    }  
                                   
                                   if (allPodsRunning) {
                                       echo "All pods are running!"
                                       break
                                   } else { 
                                       echo "Not all pods are running, waiting 10 seconds and retrying..."
                                       sleep 10
                                     }
                                }
                            }
                         }
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                      }
                   }
                }
                stage('生产环境k8s部署') {
                     when {
                          expression { BRANCH_NAME ==~ /v.*/ }
                     }
                        steps {
                                container('jenkins-slave') {
                                sh '''
                                sed -i "s#image:.*#image: ${harborAddres}/${harborRepo}/${JOB_NAME}:${TAG_NAME}#g" ${project_yaml}
                                sed -i "s#namespace:.*#namespace: ${prod_namespace}#g" ${project_yaml}
                                cat ${project_yaml}'''
                                sh '''
                                if kubectl get namespace ${prod_namespace} > /dev/null 2>&1; then
                                   echo "Namespace ${prod_namespace} already exists"
                                   kubectl apply -f ${project_yaml}
                                else
                                   echo "Namespace ${prod_namespace} does not exist, creating it now..."
                                   kubectl create namespace ${prod_namespace}
                                   echo "Namespace ${prod_namespace} created successfully!"
                                   kubectl apply -f ${project_yaml}
                                fi
                                '''
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                                }
                            }
                }
                stage('生产环境检查pod启动') {
                     when {
                          expression { BRANCH_NAME ==~ /v.*/ }
                    }
                    steps {  
                             container('jenkins-slave') {
                             script {
                             timeout(time: 3, unit: 'MINUTES') {
                                 def allPodsRunning = false
                                 while (!allPodsRunning) {
                                    def podPhase = sh(script: 'kubectl get pods -n ${prod_namespace} -o jsonpath="{range .items[*]}{.status.phase}{\\"\\n\\"}{end}"', returnStdout: true).trim()
                                    def podStatusList = podPhase.tokenize("\n")
                                    allPodsRunning = true;
                                    for (String status : podStatusList) {
                                        if (!status.equals("Running")) {
                                             allPodsRunning = false;
                                             break;
                                       }
                                    }  
                                   
                                   if (allPodsRunning) {
                                       echo "All pods are running!"
                                       break
                                   } else { 
                                       echo "Not all pods are running, waiting 10 seconds and retrying..."
                                       sleep 10
                                     }
                                }
                            }
                         }
                                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                      }
                   }
                }
        }
/*
        post {
            success {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "success: ${JOB_NAME}",
                    text: ["- 构建成功: ${JOB_NAME}! \n- 构建URL: ${BUILD_URL} \n- 构建ID: ${BUILD_ID} \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString}"]
                )
            }
            failure {
                dingtalk(
                    robot: 'Jenkins_DingDing',
                    type: 'MARKDOWN',
                    title: "failure: ${JOB_NAME}",
                    text: ["- 构建失败: ${JOB_NAME}! \n- 构建URL: ${BUILD_URL} \n- 构建ID: ${BUILD_ID} \n- 版本: ${GITLAB_COMMIT_SHORT_ID} \n- 持续时间: ${currentBuild.durationString}"]
                )
            }
        }
*/
}
```

### 2. 提交代码

```#!/bin/sh
[root@master01 java-demo]# git checkout deploy
切换到分支 'deploy'
[root@master01 java-demo]# git add .
[root@master01 java-demo]# git commit -m "Initial commit"
[root@master01 java-demo]# git push origin deploy
[root@master01 java-demo]# git checkout master
切换到分支 'master'
[root@master01 java-demo]# git add .
[root@master01 java-demo]# git commit -m "Initial commit"
[root@master01 java-demo]# git push origin master
```

### 3. 验证多环境

![](/images/posts/Devops/Devops-01-自动化运维平台/89.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/90.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/91.png)

### 4. 合并代码并且基于标签构建

![](/images/posts/Devops/Devops-01-自动化运维平台/92.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/93.png)

![](/images/posts/Devops/Devops-01-自动化运维平台/94.png)
