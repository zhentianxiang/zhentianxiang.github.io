---
layout: post
title: 2023-07-29-使用 clash 充当旁路由
date: 2023-07-29
tags: 其他
music-id: 447926063
---

## 一、透明代理和传统代理区别

透明代理是指在网络层级别对所有流量进行代理转发，无需对应用或操作系统进行特殊配置。所有网络流量都会被自动重定向到代理服务器进行处理，而用户无感知地使用代理。透明代理常用于企业或网络管理场景中，可以用于内容过滤、流量监控等目的。

普通系统代理是指通过配置系统的网络代理设置，让特定应用或整个操作系统的网络流量经过代理服务器进行转发。这种代理方式需要在每个应用程序中设置代理，或者在操作系统级别设置全局代理。普通系统代理只会对配置了代理的应用或系统流量生效，而其他未配置代理的流量仍然直接连接网络。这种方式适用于在特定应用上使用代理的场景，比如浏览器访问国外网站。



## 二、clash 透明代理

Clash 是一个强大的代理软件，支持多种代理协议，如 SOCKS5、HTTP、Shadowsocks、VMess 等。Clash 支持透明代理，可以在路由器或网关设备上运行，将局域网中的所有流量自动重定向到 Clash 代理服务器。这样，局域网中的所有设备无需配置代理，所有流量都会通过 Clash 代理进行转发。这使得局域网中的所有设备都能享受到代理带来的好处，比如翻墙、科学上网等，而无需单独配置每个设备的代理。

总结：

- 普通系统代理需要在每个应用或操作系统上进行配置，只对配置了代理的应用或系统流量生效。
- 透明代理在网络层级别对所有流量进行代理转发，无需在应用或系统上配置，对所有设备的流量都生效。
- Clash 支持透明代理，可以在路由器或网关设备上实现透明代理，让局域网中的所有设备都能享受代理服务。

## 三、部署搭建

### 1. 安装 clash

```sh
$ wget https://github.com/Dreamacro/clash/releases/download/v1.8.0/clash-linux-armv8-v1.8.0.gz

# 解压
$ gzip -d clash-linux-armv8-v1.9.0.gz

# 安装到系统 PATH
$ chmod +x clash-linux-armv8-v1.9.0

$ mv clash-linux-armv8-v1.9.0 /usr/bin/clash

# 同步IP数据库
$ clash  # 下载完，等待结束

$ mkdir /etc/clash

$ cd /etc/clash

$ wget https://github.com/haishanh/yacd/archive/gh-pages.zip

$ unzip gh-pages.zip

$ mv yacd-gh-pages/ dashboard/

$ cp ~/.config/clash/* /etc/clash

$ cat > /lib/systemd/system/clash.service <<EOF
[Unit]
Description=Clash TProxy
After=network.target

[Service]
Type=simple
User=root
Group=root
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
Restart=on-failure

ExecStartPre=/usr/bin/bash /etc/clash/clean.sh
ExecStart=/usr/bin/clash -d /etc/clash
ExecStartPost=/usr/bin/bash /etc/clash/iptables.sh

ExecStopPost=/usr/bin/bash /etc/clash/clean.sh

[Install]
WantedBy=multi-user.target
EOF
```

### 2. 准备配置文件

```yaml
mixed-port: 7890
socks-port: 7891
redir-port: 7892
tproxy-port: 7893
bind-address: '*'
allow-lan: true
mode: Rule
log-level: info
external-controller: 0.0.0.0:9090
external-ui: dashboard
dns:
  enable: true
#主要监听定向转发来的数据，后续会在路由表里配置转发端口为1053
  listen: 0.0.0.0:1053
  enhanced-mode: redir-host
  nameserver:
    - '119.29.29.29'
    - '223.5.5.5'
  fallback:
    - '8.8.8.8'
    - '8.8.4.4'
    - 'tls://1.1.1.1:853'
    - 'tcp://1.1.1.1:53'
    - 'tcp://208.67.222.222:443'
    - 'tls://dns.google'
    - 'tls://1.0.0.1:853'
    - 'tls://dns.google:853'
proxies:
************************************
************************************
************************************
************************************
```

### 3. 准备 iptables 脚本文件

```sh
$ cat iptables.sh 
#!/bin/bash
set -ex
# ENABLE ipv4 forward
sysctl -w net.ipv4.ip_forward=1
#在nat表中新建一个clash规则链
iptables -t nat -N CLASH
#排除环形地址与保留地址，匹配之后直接RETURN
iptables -t nat -A CLASH -d 0.0.0.0/8 -j RETURN
iptables -t nat -A CLASH -d 10.0.0.0/8 -j RETURN
iptables -t nat -A CLASH -d 127.0.0.0/8 -j RETURN
iptables -t nat -A CLASH -d 169.254.0.0/16 -j RETURN
iptables -t nat -A CLASH -d 172.16.0.0/12 -j RETURN
iptables -t nat -A CLASH -d 192.168.0.0/16 -j RETURN
iptables -t nat -A CLASH -d 224.0.0.0/4 -j RETURN
iptables -t nat -A CLASH -d 240.0.0.0/4 -j RETURN
#重定向tcp流量到本机7892端口
iptables -t nat -A CLASH -p tcp -j REDIRECT --to-port 7892
#拦截外部tcp数据并交给clash规则链处理
iptables -t nat -A PREROUTING -p tcp -j CLASH

#在nat表中新建一个clash_dns规则链
iptables -t nat -N CLASH_DNS
#清空clash_dns规则链
iptables -t nat -F CLASH_DNS
#重定向udp流量到本机1053端口
iptables -t nat -A CLASH_DNS -p udp -j REDIRECT --to-port 1053
#抓取本机产生的53端口流量交给clash_dns规则链处理
iptables -t nat -I OUTPUT -p udp --dport 53 -j CLASH_DNS
#拦截外部upd的53端口流量交给clash_dns规则链处理
iptables -t nat -I PREROUTING -p udp --dport 53 -j CLASH_DNS
```

```sh
#!/bin/bash

Chain_CLASH=$(iptables -t nat -vnL | grep -o "Chain CLASH" | head -n 1)

if [[ "$Chain_CLASH" == "Chain CLASH" ]]; then
    iptables -t nat -F CLASH
    iptables -t nat -X CLASH
    echo "删除CLASH链"
else
    echo "没有CLASH链"
fi

Chain_CLASH_DNS=$(iptables -t nat -vnL | grep -o "Chain CLASH_DNS" | head -n 1)

if [[ "$Chain_CLASH_DNS" == "Chain CLASH_DNS" ]]; then
    iptables -t nat -F CLASH_DNS
    iptables -t nat -X CLASH_DNS
    echo "删除CLASH_DNS链"
else
    echo "没有CLASH_DNS链"
fi

PREROUTING_CLASH_DNS=$(iptables -t nat -L PREROUTING --line | grep -o "CLASH_DNS")

if [[ "$PREROUTING_CLASH_DNS" == "CLASH_DNS" ]]; then
    iptables -t nat -D PREROUTING -p udp --dport 53 -j CLASH_DNS
    echo "删除PREROUTING中的CLASH_DNS规则"
else
    echo "PREROUTING中没有CLASH_DNS规则"
fi

PREROUTING_CLASH=$(iptables -t nat -L PREROUTING --line | grep -o "CLASH")

if [[ "$PREROUTING_CLASH" == "CLASH" ]]; then
    iptables -t nat -D PREROUTING -p tcp -j CLASH
    echo "删除PREROUTING中的CLASH规则"
else
    echo "PREROUTING中没有CLASH规则"
fi

OUTPUT_CLASH_DNS=$(iptables -t nat -L OUTPUT --line | grep -o "CLASH_DNS")

if [[ "$OUTPUT_CLASH_DNS" == "CLASH_DNS" ]]; then
    iptables -t nat -D OUTPUT -p udp --dport 53 -j CLASH_DNS
    echo "删除OUTPUT中的CLASH_DNS规则"
else
    echo "OUTPUT中没有CLASH_DNS规则"
fi
```

### 4. 启动服务

```sh
$ systemctl enable clash --now
$ systemctl status clash
● clash.service - Clash TProxy
     Loaded: loaded (/lib/systemd/system/clash.service; enabled; vendor preset: enabled)
     Active: active (running) since Sat 2023-07-29 00:03:57 CST; 2s ago
    Process: 13815 ExecStartPre=/usr/bin/bash /etc/clash/clean.sh (code=exited, status=0/SUCCESS)
    Process: 13852 ExecStartPost=/usr/bin/bash /etc/clash/iptables.sh (code=exited, status=0/SUCCESS)
   Main PID: 13851 (clash)
      Tasks: 7 (limit: 4558)
     Memory: 6.3M
     CGroup: /system.slice/clash.service
             └─13851 /usr/bin/clash -d /etc/clash

Jul 29 00:03:57 tianxiang clash[13851]: time="2023-07-29T00:03:57+08:00" level=info msg="SOCKS proxy listening at: [::]:7891"
Jul 29 00:03:57 tianxiang clash[13851]: time="2023-07-29T00:03:57+08:00" level=info msg="Redirect proxy listening at: [::]:7892"
Jul 29 00:03:57 tianxiang clash[13851]: time="2023-07-29T00:03:57+08:00" level=info msg="TProxy server listening at: [::]:7893"
Jul 29 00:03:57 tianxiang clash[13851]: time="2023-07-29T00:03:57+08:00" level=info msg="Mixed(http+socks) proxy listening at: [::]:7890"
Jul 29 00:03:57 tianxiang clash[13851]: time="2023-07-29T00:03:57+08:00" level=info msg="DNS server listening at: 0.0.0.0:1053"
Jul 29 00:03:57 tianxiang bash[13852]: + iptables -t nat -F CLASH_DNS
Jul 29 00:03:57 tianxiang bash[13852]: + iptables -t nat -A CLASH_DNS -p udp -j REDIRECT --to-port 1053
Jul 29 00:03:57 tianxiang bash[13852]: + iptables -t nat -I OUTPUT -p udp --dport 53 -j CLASH_DNS
Jul 29 00:03:57 tianxiang bash[13852]: + iptables -t nat -I PREROUTING -p udp --dport 53 -j CLASH_DNS
Jul 29 00:03:57 tianxiang systemd[1]: Started Clash TProxy.
```

浏览器访问控制台

![](/images/posts/other/使用-clash-充当旁路由/1.png)

## 四、客户端配

![](/images/posts/other/使用-clash-充当旁路由/2.png)

![](/images/posts/other/使用-clash-充当旁路由/3.png)

![](/images/posts/other/使用-clash-充当旁路由/4.png)

![](/images/posts/other/使用-clash-充当旁路由/5.png)
