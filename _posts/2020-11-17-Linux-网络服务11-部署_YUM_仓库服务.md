---
layout: post
title: Linux-网络服务11-部署_YUM_仓库服务
date: 2020-11-17
tags: Linux-网络服务
---

## 一、YUM 简介

> YUM 的前身是 YUP(Yellow dog Updater)Yellow dog Linux 的软件更新，最初由 TSS 公司 (Terra Soft Solutions,INC.)使用 Python 语音开发而成，后由杜克大学(Duck University)的 Linux 开发队伍进行改进，命名为 YUM(Yellow dog Updater , Modified)
>
> 借助于 YUM 软件仓库，可以完成安装、卸载、自动升级 rpm 软件包等任务，能够自动 查找并解决 rpm 包之间的依赖关系，而无需管理员逐个、手工地去安装每个 rpm 包，使管 理员在维护大量 Linux 服务器时更加轻松自如。特别是拥有大量 Linux 主机的本地网络中， 构建一台源服务器可以大大缓解软件安装、升级等对 Internet 的依赖。

![](/images/posts/Linux-网络服务/Linux-网络服务11-部署_YUM_仓库服务/1.png)

## 二、YUM 服务器的搭建

### 1.YUM 服务器概述

> YUM软件仓库通常借助HTTP或FTP协议来进行发布，这样可以面向网络中的所有客户 机提供软件源服务。为了便于客户机查询软件包，获取依赖关系等信息，在软件仓库中需要 提供仓库数据(Repodata)，其中收集了目录下所有 rpm 包的头部信息。

### 2.准备网络安装源(服务器端)

#### (1)准备软件仓库目录

> 光盘中的软件包

拷贝 CentOS 7.3 第一张光盘内容到本地 FTP 服务器匿名访问用户的根目录下

```
[root@yumsvr ~]# yum -y install vsftpd

[root@yumsvr ~]# mkdir /var/ftp/centos7

[root@yumsvr ~]# mount /dev/cdrom /mnt/
mount: /dev/sr0 写保护，将以只读方式挂载

[root@yumsvr ~]# cp -rf /mnt/* /var/ftp/centos7/ &
[1] 15961

[root@yumsvr ~]# jobs
[1]+  完成                  cp -i -rf /mnt/* /var/ftp/centos7/
```

> 其他软件包

```
[root@yumsvr ~]# mkdir /var/ftp/ksh
[root@yumsvr ~]# cd /var/ftp/ksh/
```

![](/images/posts/Linux-网络服务/Linux-网络服务11-部署_YUM_仓库服务/2.png)

```
[root@yumsvr ksh]# ls
ksh-20120801-37.el6_9.i686.rpm  mksh-46-8.el7.x86_64(1).rpm

[root@yumsvr ksh]# yum -y install createrepo

[root@yumsvr ksh]# createrepo -v ./

Spawning worker 0 with 2 pkgs
Worker 0: reading ksh-20120801-37.el6_9.i686.rpm
Worker 0: reading mksh-46-8.el7.x86_64(1).rpm
Workers Finished
Saving Primary metadata
Saving file lists metadata
Saving other metadata
Generating sqlite DBs
Starting other db creation: Thu Jan 10 00:53:16 2019
Ending other db creation: Thu Jan 10 00:53:16 2019
Starting filelists db creation: Thu Jan 10 00:53:16 2019
Ending filelists db creation: Thu Jan 10 00:53:16 2019
Starting primary db creation: Thu Jan 10 00:53:16 2019
Ending primary db creation: Thu Jan 10 00:53:16 2019
Sqlite DBs complete

[root@yumsvr ksh]# ls
ksh-20120801-37.el6_9.i686.rpm  mksh-46-8.el7.x86_64(1).rpm  repodata
```

#### (2)安装并启动 vsftpd 服务

```
[root@yumsvr ksh]# systemctl restart vsftpd

[root@yumsvr ksh]# systemctl enable vsftpd

Created symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.
```

### 3.配置软件仓库位置(客户机端)

#### (1)典型的仓库配置

> 1>内网 YUM 源

```
[root@client ~]# cd /etc/yum.repos.d/

[root@client yum.repos.d]# rm -rf *

[root@client yum.repos.d]# vim linuxli.repo

[centos7]
name=centos7
baseurl=ftp://192.168.100.100/centos7
gpgcheck=0
enabled=1

[ksh]
name=ksh
baseurl=ftp://192.168.100.100/ksh
gpgcheck=0
enabled=1

[root@client yum.repos.d]# yum -y clean all

已加载插件：fastestmirror
正在清理软件源： centos7 ksh
Cleaning up everything
Maybe you want: rm -rf /var/cache/yum, to also free up space taken by orphaned data from disabled or removed repos

[root@client yum.repos.d]# yum makecache
已加载插件：fastestmirror
Determining fastest mirrors
centos7                                                                        | 3.6 kB  00:00:00
ksh                                                                            | 2.9 kB  00:00:00
(1/7): centos7/group_gz                                                        | 166 kB  00:00:00
(2/7): centos7/filelists_db                                                    | 6.9 MB  00:00:00
(3/7): centos7/primary_db                                                      | 5.9 MB  00:00:00
(4/7): centos7/other_db                                                        | 2.5 MB  00:00:00
(5/7): ksh/primary_db                                                          | 3.2 kB  00:00:00
(6/7): ksh/filelists_db                                                        | 1.2 kB  00:00:00
(7/7): ksh/other_db                                                            | 2.2 kB  00:00:00
元数据缓存已建立

[root@client ~]# ls /var/cache/yum/x86_64/7/		//查看缓存是否生成
centos7  ksh  timedhosts  timedhosts.txt
```

#### 测试

```
[root@client ~]# yum -y install bind
已加载插件：fastestmirror
Loading mirror speeds from cached hostfile
正在解决依赖关系
--> 正在检查事务
---> 软件包 bind.x86_64.32.9.9.4-61.el7 将被 安装
--> 解决依赖关系完成

依赖关系解决

======================================================================================================
 Package            架构                 版本                             源                     大小
======================================================================================================
正在安装:
 bind               x86_64               32:9.9.4-61.el7                  centos7               1.8 M

事务概要
======================================================================================================
安装  1 软件包

总下载量：1.8 M
安装大小：4.3 M
Downloading packages:
bind-9.9.4-61.el7.x86_64.rpm                                                   | 1.8 MB  00:00:00
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  正在安装    : 32:bind-9.9.4-61.el7.x86_64                                                       1/1
  验证中      : 32:bind-9.9.4-61.el7.x86_64                                                       1/1

已安装:
  bind.x86_64 32:9.9.4-61.el7

完毕！
[root@client ~]#
```

> 注意:因为 ksh 包在光盘中存在，所以需先修改 repo 文件后重建 yum 缓存再进行安装 测试，否则安装的是光盘中的包。

```
[root@client ~]# vim /etc/yum.repos.d/linuxli.repo

[ksh]
name=ksh
baseurl=ftp://192.168.100.100/ksh
gpgcheck=0
enabled=1

[root@client ~]# yum clean all

已加载插件：fastestmirror
正在清理软件源： ksh
Cleaning up everything
Maybe you want: rm -rf /var/cache/yum, to also free up space taken by orphaned data from disabled or removed repos
Cleaning up list of fastest mirrors


[root@client ~]# yum makecache

已加载插件：fastestmirror
Determining fastest mirrors
ksh                                                                            | 2.9 kB  00:00:00
(1/3): ksh/filelists_db                                                        | 1.2 kB  00:00:00
(2/3): ksh/other_db                                                            | 2.2 kB  00:00:00
(3/3): ksh/primary_db                                                          | 3.2 kB  00:00:00
元数据缓存已建立

[root@client ~]# yum -y install mksh
已加载插件：fastestmirror
Loading mirror speeds from cached hostfile
正在解决依赖关系
--> 正在检查事务
---> 软件包 mksh.x86_64.0.46-8.el7 将被 安装
--> 解决依赖关系完成

依赖关系解决

======================================================================================================
 Package               架构                    版本                        源                    大小
======================================================================================================
正在安装:
 mksh                  x86_64                  46-8.el7                    ksh                  240 k

事务概要
======================================================================================================
安装  1 软件包

总下载量：240 k
安装大小：588 k
Downloading packages:
mksh-46-8.el7.x86_64(1).rpm                                                    | 240 kB  00:00:00
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  正在安装    : mksh-46-8.el7.x86_64                                                              1/1
  验证中      : mksh-46-8.el7.x86_64                                                              1/1

已安装:
  mksh.x86_64 0:46-8.el7

完毕！
[root@client ~]#
```

> 2>公网 YUM 源

```
[root@client ~]# cd /etc/yum.repos.d/

[root@client yum.repos.d]# rm -rf *

[root@client yum.repos.d]# wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

--2019-01-09 18:45:45--  http://mirrors.aliyun.com/repo/Centos-7.repo
正在解析主机 mirrors.aliyun.com (mirrors.aliyun.com)... 103.1.171.85, 103.1.171.80, 103.1.171.78, ...
正在连接 mirrors.aliyun.com (mirrors.aliyun.com)|103.1.171.85|:80... 已连接。
已发出 HTTP 请求，正在等待回应... 200 OK
长度：2523 (2.5K) [application/octet-stream]
正在保存至: “/etc/yum.repos.d/CentOS-Base.repo”

100%[============================================================>] 2,523       --.-K/s 用时 0s

2019-01-09 18:45:45 (297 MB/s) - 已保存 “/etc/yum.repos.d/CentOS-Base.repo” [2523/2523])

[root@client yum.repos.d]# ls

CentOS-Base.repo

[root@client yum.repos.d]# yum clean all

已加载插件：fastestmirror
正在清理软件源： base extras updates
Cleaning up everything
Maybe you want: rm -rf /var/cache/yum, to also free up space taken by orphaned data from disabled or removed repos
Cleaning up list of fastest mirrors

[root@client yum.repos.d]# yum makecache
```

> 测试，略。注意客户机要保证可以访问外网。

#### (2)使用本地文件夹作为软件仓库

```
[root@client yum.repos.d]# rm -rf *

[root@client yum.repos.d]# vim local.repo

[local]
name=local
baseurl=file:///mnt/
gpgcheck=0
enabled=1

[root@client yum.repos.d]# mount /dev/cdrom /mnt/

[root@client yum.repos.d]# yum -y clean all

[root@client yum.repos.d]# yum makecache
```

> 测试

```
[root@client yum.repos.d]# yum -y install ftp
已加载插件：fastestmirror
Loading mirror speeds from cached hostfile
正在解决依赖关系
--> 正在检查事务
---> 软件包 ftp.x86_64.0.0.17-67.el7 将被 安装
--> 解决依赖关系完成

依赖关系解决

======================================================================================================
 Package             架构                   版本                          源                     大小
======================================================================================================
正在安装:
 ftp                 x86_64                 0.17-67.el7                   local                  61 k

事务概要
======================================================================================================
安装  1 软件包

总下载量：61 k
安装大小：96 k
Downloading packages:
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  正在安装    : ftp-0.17-67.el7.x86_64                                                            1/1
  验证中      : ftp-0.17-67.el7.x86_64                                                            1/1

已安装:
  ftp.x86_64 0:0.17-67.el7

完毕！
```

## 三、yum 命令

### 1.基本操作

#### (1)查询软件包列表:

> yum list、yum grouplist

> yum list installed 查询已安装的包

> yum list available 查询可以安装(未安装)的包

#### (2)查询软件包的描述信息:

> yum info 软件包名

#### (3)查询指定软件包:

> yum search 软件包名

#### (4)清理 yum 缓存:

> yum -y clean all

#### (5)重建 yum 缓存:

> yum makecache

### 2.针对单个安装包的操作

> (1)安装:yum -y install

> (2)卸载:yum -y remove 或 yum -y erase

> (3)升级:yum -y update

### 3.针对安装包组的操作

> (1)安装:yum -y groupinstall “软件包组名称”

> (2)卸载:yum -y groupremove

> (3)升级:yum -y groupupdate

> 选项-y 表示不进行交互，回答 yes。

## 四、构建自动同步公网的内网源

> 通过yum特有的同步协议进行同步公网源，可以将大量软件包同步到本地服务器，然后本地服务器通过http协议给内网主机使用，可以节省大量的出口带宽

### 1. 使用 docker 搭建 YUM 镜像源

```sh
[root@server ~]# mkdir /data/docker/centos7_yum
[root@server ~]# cd /data/docker/centos7_yum
[root@server ~]# cat Dockerfile 
FROM centos:7

RUN rm -rf /etc/yum.repos.d/* && \
    curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo && \
    curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo && \
    curl -o /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo && \
    curl -o /etc/yum.repos.d/nvidia-docker.repo https://nvidia.github.io/nvidia-docker/centos7/nvidia-docker.repo && \
    sed -i 's/repo_gpgcheck=1/repo_gpgcheck=0/g' /etc/yum.repos.d/nvidia-docker.repo && \
    yum -y install \
    createrepo \
    yum-utils \
    nginx

RUN rm -rf /var/cache/yum/*

COPY kubernetes.repo /etc/yum.repos.d/kubernetes.repo

COPY centos_yum_update.sh /usr/bin/centos_yum_update.sh

CMD ["/bin/bash", "/usr/bin/centos_yum_update.sh"]
[root@server ~]# cat kubernetes.repo 
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg

[root@server ~]# cat centos_yum_update.sh 
#!/bin/bash

# 脚本主体函数
main() {
    # 从环境变量获取更新时间，如果没有设置，则默认为每天0点
    UPDATE_TIME=${UPDATE_TIME:-"00:00"}

    # 获取更新时间的时间戳
    local next_run_time=$(date --date="today $UPDATE_TIME" "+%s")
    local current_time=$(date "+%s") # 获取当前时间的时间戳

    # 无限循环
    while true; do
        # 检查当前时间是否到了或过了更新时间
        if [ $current_time -ge $next_run_time ]; then
            echo "检查nginx服务状态..."
            if ! pgrep -x "nginx" > /dev/null; then
                echo "nginx 正在启动..."
                nginx
            else
                echo "nginx 进程已存在。"
            fi

            echo "准备同步阿里云镜像仓库源"
            DATETIME=$(date +%F_%H-%M-%S)
            LOGFILE="/var/log/aliyunrepo_$DATETIME.log"

            {
                reposync -np /centos7_mirrors
                ls /centos7_mirrors
                if [ $? -eq 0 ]; then
                    echo "同步成功，开始更新仓库"
                    REPO_PATHS=(
                        "/centos7_mirrors/base/Packages"
                        "/centos7_mirrors/extras/Packages"
                        "/centos7_mirrors/updates/Packages"
                        "/centos7_mirrors/epel/Packages"
                        "/centos7_mirrors/kubernetes/Packages"
                        "/centos7_mirrors/docker-ce-stable"
                        "/centos7_mirrors/nvidia-docker"
                        "/centos7_mirrors/nvidia-container-runtime"
                        "/centos7_mirrors/libnvidia-container"
                    )

                    sync_success=true  # 标志变量，初始值为成功

                    for REPO in "${REPO_PATHS[@]}"; do
                        createrepo --update "$REPO"
                        if [ $? -eq 0 ]; then
                            echo "SUCCESS: $DATETIME updated $REPO"
                        else
                            echo "ERROR: $DATETIME failed to update $REPO"
                            sync_success=false  # 只要有一个失败，就设置为 false
                            failed_repos+=("$REPO")  # 记录失败的镜像源
                        fi
                    done

                    if [ "$sync_success" = true ]; then
                        echo "SUCCESS: $DATETIME 阿里云镜像源同步成功"
                    else
                        echo "ERROR: $DATETIME 阿里云镜像源同步失败"
                        echo "失败的镜像源目录如下："
                        for FAILED_REPO in "${failed_repos[@]}"; do
                            echo "$FAILED_REPO"
                        done
                    fi

                else
                    echo "ERROR: $DATETIME aliyum_yum update failed"
                fi
            } 2>&1 | tee -a "$LOGFILE"

            # 更新 next_run_time 为次日的更新时间的时间戳
            next_run_time=$(date --date="tomorrow $UPDATE_TIME" "+%s")
        fi

        # 等待直到 next_run_time
        sleep $((next_run_time - current_time))
        current_time=$(date "+%s")
    done
}

# 调用 main 函数
main

[root@server ~]# docker build . -t zhentianxiang/reposync:v1.0.0
```

### 2. 准备挂载文件

```sh
# CentOS-Base.repo 文件
[root@server ~]# mkdir repo
[root@server ~]# vim repo/CentOS-Base.repo 
[centos7_base]
name=localServer
baseurl=http://mirrors.tianxiang.love/base/Packages
gpgcheck=0
enabled=1

[centos7_extras]
name=localServer
baseurl=http://mirrors.tianxiang.love/extras/Packages
gpgcheck=0
enabled=1

[centos7_updates]
name=localServer
baseurl=http://mirrors.tianxiang.love/updates/Packages
gpgcheck=0
enabled=1

[epel]
name=localServer
baseurl=http://mirrors.tianxiang.love/epel/Packages
gpgcheck=0
enabled=1

[kubernetes]
name=localServer
baseurl=http://mirrors.tianxiang.love/kubernetes/Packages
gpgcheck=0
enabled=1

[docker-ce]
name=localServer
baseurl=http://mirrors.tianxiang.love/docker-ce-stable/
gpgcheck=0
enabled=1

[nvidia-container-runtime]
name=localServer
baseurl=http://mirrors.tianxiang.love/nvidia-container-runtime
gpgcheck=0
enabled=1

[nvidia-docker]
name=localServer
baseurl=http://mirrors.tianxiang.love/nvidia-docker
gpgcheck=0
enabled=1

[libnvidia-container]
name=localServer
baseurl=http://mirrors.tianxiang.love/libnvidia-container
gpgcheck=0
enabled=1

# nginx 主配置文件
[root@server ~]# vim nginx.conf 
# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  /var/log/nginx/access.log  main;
    access_log /dev/stdout main;
    error_log /dev/stderr warn;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 4096;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    server {
        listen 80 default_server;
        server_name _;
        root         /usr/share/nginx/html;

        # Load configuration files for the default server block.

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
    }

# Settings for a TLS enabled server.
#
#    server {
#        listen       443 ssl http2;
#        listen       [::]:443 ssl http2;
#        server_name  _;
#        root         /usr/share/nginx/html;
#
#        ssl_certificate "/etc/pki/nginx/server.crt";
#        ssl_certificate_key "/etc/pki/nginx/private/server.key";
#        ssl_session_cache shared:SSL:1m;
#        ssl_session_timeout  10m;
#        ssl_ciphers HIGH:!aNULL:!MD5;
#        ssl_prefer_server_ciphers on;
#
#        # Load configuration files for the default server block.
#        include /etc/nginx/default.d/*.conf;
#
#        error_page 404 /404.html;
#            location = /40x.html {
#        }
#
#        error_page 500 502 503 504 /50x.html;
#            location = /50x.html {
#        }
#    }

}

# server 主机文件
[root@server ~]# vim mirrors.conf 
server {
    listen 80;
    server_name mirrors.tianxiang.love; # 注意：这里要写你访问的IP或者域名，否则没写对的话访问80端口就会访问到默认的default中，要靠具体的请求地址来区分的

    root /centos7_mirrors;
    index index.html;

    location / {
        default_type text/plain;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        charset utf-8,gbk;
        try_files $uri $uri/ =404;
    }
}

# 前端展示页面
[root@server ~]# vim repo/index.html 
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CentOS 7 网络源</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #34495e;
            color: white;
            padding: 1em 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .container {
            padding: 2em;
            max-width: 900px;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5em;
        }
        .copy-btn {
            cursor: pointer;
            padding: 0.5em 1em;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
            margin-left: 0.5em;
        }
        .alert {
            background-color: white;
            border-radius: 8px;
            padding: 1.5em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .alert:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .alert h2 {
            margin-top: 0;
            color: #34495e;
            font-size: 1.5em;
        }
        .alert a {
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
        }
        .alert a:hover {
            text-decoration: underline;
        }
        footer {
            text-align: center;
            padding: 1em 0;
            background-color: #34495e;
            color: white;
            position: fixed;
            width: 100%;
            bottom: 0;
        }
        .footer-space {
            height: 4em; /* Adjust the height to the footer's height */
        }
    </style>
</head>
<body>
    <header>
        <h1>CentOS 7 网络源</h1>
    </header>
    <div class="container">
        <p>此镜像站可以私有化部署到局域网中,以便内网快速下载使用过yum源仓库.</p>
        <div class="alert">
            <h2>CentOS 7 Base</h2>
            <p><a href="/base">点击查看软件包</a></p>
        </div>
        <div class="alert">
            <h2>CentOS 7 Extras</h2>
            <p><a href="/extras">点击查看软件包</a></p>
        </div>
        <div class="alert">
            <h2>CentOS 7 Updates</h2>
            <p><a href="/updates">点击查看软件包</a></p>
        </div>
        <div class="alert">
            <h2>EPEL</h2>
            <p><a href="/epel">点击查看软件包</a></p>
        </div>
        <div class="alert">
            <h2>Docker CE</h2>
            <p><a href="/docker-ce-stable">点击查看软件包</a></p>
        </div>
        <div class="alert">
            <h2>Kubernetes</h2>
            <p><a href="/kubernetes">点击查看软件包</a></p>
        </div>
        <div class="alert">
            <h2>NVIDIA 容器运行时</h2>
            <p><a href="/nvidia-container-runtime">点击查看软件包</a></p>
        </div>
        <div class="alert">
            <h2>LibNVIDIA 容器</h2>
            <p><a href="/libnvidia-container">点击查看软件包</a></p>
        </div>
        <div class="alert">
            <h2>NVIDIA Docker</h2>
            <p><a href="/nvidia-docker">点击查看软件包</a></p>
        </div>
    </div>
    <div class="footer-space"></div>
    <footer>
        <p>使用方法 : <code id="usage-code">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.tianxiang.love/CentOS-Base.repo</code> <button class="copy-btn" data-clipboard-text="" onclick="copyToClipboard(this)">复制命令</button></p> 
    </footer>
      <script>
          function copyToClipboard(element) {
              // 创建一个不可见的textarea元素
              var tempTextarea = document.createElement('textarea');
              tempTextarea.value = document.getElementById('usage-code').textContent;
              document.body.appendChild(tempTextarea);
      
              // 选中文本并复制
              tempTextarea.select();
              document.execCommand('copy');
      
              // 删除临时textarea
              document.body.removeChild(tempTextarea);
      
              // 改变按钮的文本
              element.textContent = '已复制';
              setTimeout(function() {
                  element.textContent = '复制命令';
              }, 2000); // 2秒后恢复按钮文本
          }
      </script>
</body>
</html>
```

### 3. 启动容器

```sh
[root@server ~]# cat docker-compose.yaml 
services:
  centos7_mirrors:
    container_name: centos7-mirrors
    image: registry.cn-hangzhou.aliyuncs.com/tianxiang_app/centos7_aliyun_synclocal:v1.0.1
    ports:
      - 80:80
    environment:
      UPDATE_TIME: "1:30"
      TZ: "Asia/Shanghai"
    volumes:
      - ./repo:/centos7_mirrors
      - ./mirrors.conf:/etc/nginx/conf.d/mirrors.conf
      - ./nginx.conf:/etc/nginx/nginx.conf
    restart: always

[root@server ~]# docker-compose up -d
[+] Running 1/0
 ✔ Container centos7_yum  Running
```

### 4. 查看日志

```sh
[root@server ~]# docker logs centos7_yum -f
nginx 正在启动...
准备同步阿里云镜像仓库源
日志保存路径为/var/log/aliyunrepo_2024-08-19_16:37:57.log
base                                                     | 3.6 kB     00:00     
docker-ce-stable                                         | 3.5 kB     00:00     
epel                                                     | 4.3 kB     00:00     
extras                                                   | 2.9 kB     00:00     
kubernetes                                               | 1.4 kB     00:00     
libnvidia-container                                      | 2.1 kB     00:00     
nvidia-container-runtime                                 | 2.1 kB     00:00     
nvidia-docker                                            | 2.1 kB     00:00     
updates                                                  | 2.9 kB     00:00     
(1/13): base/7/x86_64/group_gz                             | 153 kB   00:00     
(2/13): docker-ce-stable/7/x86_64/updateinfo               |   55 B   00:00     
(3/13): docker-ce-stable/7/x86_64/primary_db               | 152 kB   00:01     
(4/13): epel/x86_64/group                                  | 399 kB   00:01     
(5/13): kubernetes/primary                                 | 137 kB   00:00     
(6/13): extras/7/x86_64/primary_db                         | 253 kB   00:01     
(7/13): epel/x86_64/updateinfo                             | 1.0 MB   00:03     
(8/13): libnvidia-container/x86_64/primary                 |  35 kB   00:01     
(9/13): nvidia-container-runtime/x86_64/primary            |  11 kB   00:01     
(10/13): nvidia-docker/x86_64/primary                      | 8.0 kB   00:01     
base/7/x86_64/primary_db       FAILED                                           
base/7/x86_64/primary_db       FAILED                                           
updates/7/x86_64/primary_db    FAILED                                           
(11/13): base/7/x86_64/primary_db                          | 6.1 MB   00:20     
(12/13): epel/x86_64/primary_db                            | 8.7 MB   00:28     
(13/13): updates/7/x86_64/ 94% [=============== ] 317 kB/s |  42 MB   00:07 ETA
```

### 5. k8s 部署

- deployment

```sh
[root@node141 centos7-mirrors]# cat deployment.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: centos7-mirrors
spec:
  replicas: 1
  selector:
    matchLabels:
      app: centos7-mirrors
  template:
    metadata:
      labels:
        app: centos7-mirrors
    spec:
      containers:
        - name: centos7-mirrors
          image: registry.cn-hangzhou.aliyuncs.com/tianxiang_app/centos7_aliyun_synclocal:v1.0.1
          ports:
            - containerPort: 80
          env:
            - name: UPDATE_TIME
              value: "1:30"
            - name: TZ
              value: "Asia/Shanghai"
          volumeMounts:
            - name: repo-storage
              mountPath: /centos7_mirrors
            - name: mirrors-config
              mountPath: /etc/nginx/conf.d/mirrors.conf
              subPath: mirrors.conf
            - name: mirrors-front-config
              mountPath: /centos7_mirrors/index.html
              subPath: index.html
            - name: centos7-mirrors-base
              mountPath: /centos7_mirrors/CentOS-Base.repo
              subPath: CentOS-Base.repo
            - name: nginx-config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
      volumes:
        - name: repo-storage
          persistentVolumeClaim:
            claimName: centos7-mirrors-pvc
        - name: mirrors-config
          configMap:
            name: centos7-mirrors-config
        - name: mirrors-front-config
          configMap:
            name: centos7-mirrors-config
        - name: centos7-mirrors-base
          configMap:
            name: centos7-mirrors-config
        - name: nginx-config
          configMap:
            name: centos7-mirrors-config
```

- configmap

```sh
[root@node141 centos7-mirrors]# cat config.yaml 
apiVersion: v1
kind: ConfigMap
metadata:
  name: centos7-mirrors-config
data:
  mirrors.conf: |
    server {
        listen 80;
        server_name mirrors.tianxiang.love; # 注意：这里要写你访问的IP或者域名，否则没写对的话访问80端口就会访问到默认的default中，要靠具体的请求地址来区分的
    
        root /centos7_mirrors;
        index index.html;
    
        location / {
            default_type text/plain;
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
            charset utf-8,gbk;
            try_files $uri $uri/ =404;
        }
    }
  index.html: |
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CentOS 7 网络源</title>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Roboto', sans-serif;
                background-color: #f0f2f5;
                margin: 0;
                padding: 0;
                color: #333;
                display: flex;
                flex-direction: column;
                min-height: 100vh;
            }
            header {
                background-color: #34495e;
                color: white;
                padding: 1em 0;
                text-align: center;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            h1 {
                margin: 0;
                font-size: 2.5em;
            }
            .container {
                padding: 2em;
                max-width: 900px;
                margin: 0 auto;
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 1.5em;
            }
            .copy-btn {
                cursor: pointer;
                padding: 0.5em 1em;
                background-color: #3498db;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 0.9em;
                margin-left: 0.5em;
            }
            .alert {
                background-color: white;
                border-radius: 8px;
                padding: 1.5em;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .alert:hover {
                transform: translateY(-5px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            }
            .alert h2 {
                margin-top: 0;
                color: #34495e;
                font-size: 1.5em;
            }
            .alert a {
                color: #3498db;
                text-decoration: none;
                font-weight: bold;
            }
            .alert a:hover {
                text-decoration: underline;
            }
            footer {
                text-align: center;
                padding: 1em 0;
                background-color: #34495e;
                color: white;
                position: fixed;
                width: 100%;
                bottom: 0;
            }
            .footer-space {
                height: 4em; /* Adjust the height to the footer's height */
            }
        </style>
    </head>
    <body>
        <header>
            <h1>CentOS 7 网络源</h1>
        </header>
        <div class="container">
            <p>此镜像站可以私有化部署到局域网中,以便内网快速下载使用过yum源仓库.</p>
            <div class="alert">
                <h2>CentOS 7 Base</h2>
                <p><a href="/base">点击查看软件包</a></p>
            </div>
            <div class="alert">
                <h2>CentOS 7 Extras</h2>
                <p><a href="/extras">点击查看软件包</a></p>
            </div>
            <div class="alert">
                <h2>CentOS 7 Updates</h2>
                <p><a href="/updates">点击查看软件包</a></p>
            </div>
            <div class="alert">
                <h2>EPEL</h2>
                <p><a href="/epel">点击查看软件包</a></p>
            </div>
            <div class="alert">
                <h2>Docker CE</h2>
                <p><a href="/docker-ce-stable">点击查看软件包</a></p>
            </div>
            <div class="alert">
                <h2>Kubernetes</h2>
                <p><a href="/kubernetes">点击查看软件包</a></p>
            </div>
            <div class="alert">
                <h2>NVIDIA 容器运行时</h2>
                <p><a href="/nvidia-container-runtime">点击查看软件包</a></p>
            </div>
            <div class="alert">
                <h2>LibNVIDIA 容器</h2>
                <p><a href="/libnvidia-container">点击查看软件包</a></p>
            </div>
            <div class="alert">
                <h2>NVIDIA Docker</h2>
                <p><a href="/nvidia-docker">点击查看软件包</a></p>
            </div>
        </div>
        <div class="footer-space"></div>
        <footer>
            <p>使用方法 : <code id="usage-code">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.tianxiang.love/CentOS-Base.repo</code> <button class="copy-btn" data-clipboard-text="" onclick="copyToClipboard(this)">复制命令</button></p> 
        </footer>
          <script>
              function copyToClipboard(element) {
                  // 创建一个不可见的textarea元素
                  var tempTextarea = document.createElement('textarea');
                  tempTextarea.value = document.getElementById('usage-code').textContent;
                  document.body.appendChild(tempTextarea);
          
                  // 选中文本并复制
                  tempTextarea.select();
                  document.execCommand('copy');
          
                  // 删除临时textarea
                  document.body.removeChild(tempTextarea);
          
                  // 改变按钮的文本
                  element.textContent = '已复制';
                  setTimeout(function() {
                      element.textContent = '复制命令';
                  }, 2000); // 2秒后恢复按钮文本
              }
          </script>
    </body>
    </html>
  nginx.conf: |
    # For more information on configuration, see:
    #   * Official English Documentation: http://nginx.org/en/docs/
    #   * Official Russian Documentation: http://nginx.org/ru/docs/
    
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log;
    pid /run/nginx.pid;
    
    # Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
    include /usr/share/nginx/modules/*.conf;
    
    events {
        worker_connections 1024;
    }
    
    http {
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';
    
        #access_log  /var/log/nginx/access.log  main;
        access_log /dev/stdout main;
        error_log /dev/stderr warn;
    
        sendfile            on;
        tcp_nopush          on;
        tcp_nodelay         on;
        keepalive_timeout   65;
        types_hash_max_size 4096;
    
        include             /etc/nginx/mime.types;
        default_type        application/octet-stream;
    
        # Load modular configuration files from the /etc/nginx/conf.d directory.
        # See http://nginx.org/en/docs/ngx_core_module.html#include
        # for more information.
        include /etc/nginx/conf.d/*.conf;
    
        server {
            listen 80 default_server;
            server_name _;
            root         /usr/share/nginx/html;
    
            # Load configuration files for the default server block.
    
            error_page 404 /404.html;
            location = /404.html {
            }
    
            error_page 500 502 503 504 /50x.html;
            location = /50x.html {
            }
        }
    
    # Settings for a TLS enabled server.
    #
    #    server {
    #        listen       443 ssl http2;
    #        listen       [::]:443 ssl http2;
    #        server_name  _;
    #        root         /usr/share/nginx/html;
    #
    #        ssl_certificate "/etc/pki/nginx/server.crt";
    #        ssl_certificate_key "/etc/pki/nginx/private/server.key";
    #        ssl_session_cache shared:SSL:1m;
    #        ssl_session_timeout  10m;
    #        ssl_ciphers HIGH:!aNULL:!MD5;
    #        ssl_prefer_server_ciphers on;
    #
    #        # Load configuration files for the default server block.
    #        include /etc/nginx/default.d/*.conf;
    #
    #        error_page 404 /404.html;
    #            location = /40x.html {
    #        }
    #
    #        error_page 500 502 503 504 /50x.html;
    #            location = /50x.html {
    #        }
    #    }
    
    }
  CentOS-Base.repo: |
    [centos7_base]
    name=localServer
    baseurl=http://mirrors.tianxiang.love/base/Packages
    gpgcheck=0
    enabled=1
    
    [centos7_extras]
    name=localServer
    baseurl=http://mirrors.tianxiang.love/extras/Packages
    gpgcheck=0
    enabled=1
    
    [centos7_updates]
    name=localServer
    baseurl=http://mirrors.tianxiang.love/updates/Packages
    gpgcheck=0
    enabled=1
    
    [epel]
    name=localServer
    baseurl=http://mirrors.tianxiang.love/epel/Packages
    gpgcheck=0
    enabled=1
    
    [kubernetes]
    name=localServer
    baseurl=http://mirrors.tianxiang.love/kubernetes/Packages
    gpgcheck=0
    enabled=1
    
    [docker-ce]
    name=localServer
    baseurl=http://mirrors.tianxiang.love/docker-ce-stable/
    gpgcheck=0
    enabled=1
    
    [nvidia-container-runtime]
    name=localServer
    baseurl=http://mirrors.tianxiang.love/nvidia-container-runtime
    gpgcheck=0
    enabled=1
    
    [nvidia-docker]
    name=localServer
    baseurl=http://mirrors.tianxiang.love/nvidia-docker
    gpgcheck=0
    enabled=1
    
    [libnvidia-container]
    name=localServer
    baseurl=http://mirrors.tianxiang.love/libnvidia-container
    gpgcheck=0
    enabled=1
```

- loacl-storage

```sh
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Retain
```

- pvc

```sh
[root@node141 centos7-mirrors]# cat data-pvc.yaml 
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv
spec:
  capacity:
    storage: 100Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  local:
    path: /mnt/disks/mydisk  # 本地存储路径，确保路径存在且已挂载
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - node141  # 使用特定节点的名称
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: local-pvc
spec:
  storageClassName: local-storage
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Gi
```

- service

```sh
[root@node141 centos7-mirrors]# cat service.yaml 
apiVersion: v1
kind: Service
metadata:
  name: centos7-mirrors
  labels:
    app: centos7-mirrors
spec:
  type: NodePort
  selector:
    app: centos7-mirrors
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
```

- ingress

```sh
[root@node141 centos7-mirrors]# cat ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: centos7-mirrors
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
  labels:
    name: centos7-mirrors
spec:
  ingressClassName: nginx
  rules:
  - host: mirrors.meta42.indc.vnet.com
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: centos7-mirrors
            port:
              number: 80
```

查看日志

```sh
[root@node141 centos7-mirrors]# kubectl apply -f .
[root@node141 centos7-mirrors]# kubectl get pods 
NAME                               READY   STATUS    RESTARTS   AGE
centos7-mirrors-749b9c7654-t5lmt   1/1     Running   0          12m
[root@node141 centos7-mirrors]# kubectl logs centos7-mirrors-749b9c7654-t5lmt --tail=100 -f
(2345/10072): gspell-1.6.1-1.el7.i686.rpm                  |  91 kB   00:00     
(2346/10072): gspell-1.6.1-1.el7.x86_64.rpm                |  91 kB   00:00     
(2347/10072): gspell-devel-1.6.1-1.el7.i686.rpm            |  26 kB   00:00     
(2348/10072): gspell-devel-1.6.1-1.el7.x86_64.rpm          |  26 kB   00:00     
(2349/10072): gspell-doc-1.6.1-1.el7.noarch.rpm            |  35 kB   00:00
```